<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/routes/settings.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showFeedback">showFeedback</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showPriceAlert">showPriceAlert</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/routes/settings.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Persistent Settings Storage and Management Routes
 *
 * This module handles persistent application settings including price alert thresholds,
 * automation toggles, and notification preferences. Settings are stored in a JSON file
 * and synchronized across all connected WebSocket clients in real-time.
 *
 * Key Features:
 * - Persistent storage in settings.json (survives server restarts)
 * - Default settings fallback when file missing or corrupted
 * - Input validation and type coercion for all settings
 * - Real-time synchronization via WebSocket broadcast
 * - Graceful error handling with sensible defaults
 *
 * Why This Module:
 * - Centralizes user preferences and automation configuration
 * - Enables price alerts and auto-rebuy features
 * - Provides consistent settings across multiple client tabs
 * - Persists user choices between sessions
 * - Allows dynamic reconfiguration without server restart
 *
 * Settings Categories:
 * 1. Alert Thresholds:
 *    - fuelThreshold: Price alert for fuel ($/ton)
 *    - co2Threshold: Price alert for CO2 ($/ton)
 *    - maintenanceThreshold: Vessel condition alert (%)
 *
 * 2. Auto-Rebuy Settings:
 *    - autoRebuyFuel: Enable automatic fuel purchasing
 *    - autoRebuyFuelUseAlert: Use alert threshold (or custom threshold)
 *    - autoRebuyFuelThreshold: Custom fuel purchase threshold
 *    - autoRebuyCO2: Enable automatic CO2 purchasing
 *    - autoRebuyCO2UseAlert: Use alert threshold (or custom threshold)
 *    - autoRebuyCO2Threshold: Custom CO2 purchase threshold
 *
 * 3. Automation Toggles:
 *    - autoDepartAll: Auto-depart all vessels when ready
 *    - autoBulkRepair: Auto-repair all vessels below threshold
 *    - autoCampaignRenewal: Auto-renew marketing campaigns
 *    - autoPilotNotifications: Enable browser notifications for automation
 *
 * 4. Intelligent Auto-Depart Settings:
 *    - autoDepartUseRouteDefaults: Use route defaults vs custom values (default true)
 *    - minVesselUtilization: Minimum vessel capacity utilization % (default 45%)
 *    - autoVesselSpeed: Vessel speed as % of max_speed (default 50%)
 *
 * Default Values:
 * - Fuel alert: $400/ton (industry competitive price)
 * - CO2 alert: $7/ton (low market price)
 * - Maintenance alert: 10% vessel condition
 * - All automation: Disabled by default (user opt-in required)
 * - Vessel utilization: 45% minimum (prevents unprofitable trips)
 * - Vessel speed: 50% of max_speed (fuel cost optimization)
 * - Auto-depart: Use route defaults enabled (respects per-route settings)
 *
 * Synchronization:
 * - Settings changes broadcast to all connected WebSocket clients
 * - Message type: 'settings_update' with full settings object
 * - Ensures consistent UI state across all open tabs/devices
 *
 * @requires express - Router and middleware
 * @requires fs/promises - Async file system operations
 * @requires path - Path resolution for settings.json
 * @requires ../websocket - WebSocket broadcast function
 * @module server/routes/settings
 */

const express = require('express');
const router = express.Router();
const fs = require('fs').promises;
const path = require('path');
const { broadcast } = require('../websocket');

/**
 * Path to persistent settings storage file.
 * Located in project root: settings.json
 *
 * @constant {string}
 */
const SETTINGS_FILE = path.join(__dirname, '../../settings.json');

/**
 * GET /api/settings - Retrieves current application settings from persistent storage.
 *
 * This endpoint reads the settings.json file and returns the current configuration.
 * If the file doesn't exist or is corrupted (invalid JSON), it returns default settings
 * without creating the file (lazy initialization - file created on first POST).
 *
 * Why Graceful Fallback:
 * - First run: settings.json doesn't exist yet
 * - Corruption: Manual edits or disk errors may invalidate JSON
 * - Migration: Upgrading from older versions without settings file
 * - Never breaks UI: Always returns valid settings object
 *
 * Default Settings Philosophy:
 * - Conservative price thresholds ($400 fuel, $7 CO2)
 * - All automation disabled (requires explicit user opt-in)
 * - Safe defaults prevent accidental spending or API abuse
 *
 * Response Structure:
 * {
 *   // Alert thresholds
 *   fuelThreshold: 400,           // $/ton fuel price alert
 *   co2Threshold: 7,              // $/ton CO2 price alert
 *   maintenanceThreshold: 10,     // % vessel condition alert
 *
 *   // Auto-rebuy fuel settings
 *   autoRebuyFuel: false,         // Enable auto fuel purchasing
 *   autoRebuyFuelUseAlert: true,  // Use alert threshold (vs custom)
 *   autoRebuyFuelThreshold: 400,  // Custom threshold if not using alert
 *
 *   // Auto-rebuy CO2 settings
 *   autoRebuyCO2: false,          // Enable auto CO2 purchasing
 *   autoRebuyCO2UseAlert: true,   // Use alert threshold (vs custom)
 *   autoRebuyCO2Threshold: 7,     // Custom threshold if not using alert
 *
 *   // Automation features
 *   autoDepartAll: false,         // Auto-depart all vessels
 *   autoBulkRepair: false,        // Auto-repair vessels below threshold
 *   autoCampaignRenewal: false,   // Auto-renew marketing campaigns
 *   autoPilotNotifications: false,// Browser notifications for automation
 *
 *   // Intelligent auto-depart settings
 *   autoDepartUseRouteDefaults: true, // Use route defaults vs custom
 *   minVesselUtilization: 45,     // Minimum % capacity utilization
 *   autoVesselSpeed: 50           // % of max_speed (fuel optimization)
 * }
 *
 * Side Effects:
 * - Reads settings.json from disk
 * - Logs error to console if file missing/corrupted (doesn't throw)
 *
 * @name GET /api/settings
 * @function
 * @memberof module:server/routes/settings
 * @param {express.Request} req - Express request object
 * @param {express.Response} res - Express response object
 * @returns {Promise&lt;void>} Sends JSON response with settings object
 */
router.get('/settings', async (req, res) => {
  try {
    const data = await fs.readFile(SETTINGS_FILE, 'utf8');
    const settings = JSON.parse(data);
    res.json(settings);
  } catch (error) {
    console.error('Error reading settings:', error);
    // Return default settings if file doesn't exist or is corrupted
    res.json({
      fuelThreshold: 400,
      co2Threshold: 7,
      maintenanceThreshold: 10,
      autoRebuyFuel: false,
      autoRebuyFuelUseAlert: true,
      autoRebuyFuelThreshold: 400,
      autoRebuyCO2: false,
      autoRebuyCO2UseAlert: true,
      autoRebuyCO2Threshold: 7,
      autoDepartAll: false,
      autoBulkRepair: false,
      autoRepairInterval: '2-3',
      autoCampaignRenewal: false,
      autoPilotNotifications: false,
      autoDepartUseRouteDefaults: true,
      minVesselUtilization: 45,
      autoVesselSpeed: 50
    });
  }
});

/**
 * POST /api/settings - Updates application settings and persists to disk.
 *
 * This endpoint receives settings from the frontend, validates and sanitizes the input,
 * writes the validated settings to settings.json, and broadcasts the update to all
 * connected WebSocket clients for real-time synchronization.
 *
 * Why Input Validation:
 * - Frontend can send malformed data (type errors, missing fields)
 * - Manual API calls may have incorrect types
 * - Ensures settings.json always contains valid data structure
 * - Prevents automation bugs from invalid threshold values
 *
 * Validation Strategy:
 * - Numeric thresholds: parseInt() with fallback defaults
 * - Boolean toggles: Double-negation coercion (!!)
 * - Optional booleans: undefined check before coercion
 * - All fields validated individually (no blind trust)
 *
 * Default Fallbacks:
 * - Invalid numbers default to conservative thresholds ($400 fuel, $7 CO2, 10% maint)
 * - autoRebuyFuelUseAlert defaults to true if undefined
 * - autoRebuyCO2UseAlert defaults to true if undefined
 * - Boolean toggles default to false if falsy
 *
 * Real-Time Synchronization:
 * - WebSocket broadcast: 'settings_update' message type
 * - All connected clients receive updated settings
 * - Frontend updates UI state immediately
 * - Multi-tab synchronization (change in one tab updates all tabs)
 *
 * Request Body:
 * {
 *   fuelThreshold: number,
 *   co2Threshold: number,
 *   maintenanceThreshold: number,
 *   autoRebuyFuel: boolean,
 *   autoRebuyFuelUseAlert: boolean,
 *   autoRebuyFuelThreshold: number,
 *   autoRebuyCO2: boolean,
 *   autoRebuyCO2UseAlert: boolean,
 *   autoRebuyCO2Threshold: number,
 *   autoDepartAll: boolean,
 *   autoBulkRepair: boolean,
 *   autoCampaignRenewal: boolean,
 *   autoPilotNotifications: boolean,
 *   autoDepartUseRouteDefaults: boolean,
 *   minVesselUtilization: number,
 *   autoVesselSpeed: number
 * }
 *
 * Response Format:
 * {
 *   success: true,
 *   settings: { ...validatedSettings }
 * }
 *
 * Side Effects:
 * - Writes settings.json to project root (overwrites existing file)
 * - Broadcasts settings_update to all WebSocket clients
 * - Triggers frontend settings update in all connected tabs
 *
 * @name POST /api/settings
 * @function
 * @memberof module:server/routes/settings
 * @param {express.Request} req - Express request object with settings in body
 * @param {express.Response} res - Express response object
 * @returns {Promise&lt;void>} Sends JSON response with success status and validated settings
 */
router.post('/settings', async (req, res) => {
  try {
    const settings = req.body;

    // Validate settings structure
    const validSettings = {
      fuelThreshold: parseInt(settings.fuelThreshold) || 400,
      co2Threshold: parseInt(settings.co2Threshold) || 7,
      maintenanceThreshold: parseInt(settings.maintenanceThreshold) || 10,
      autoRebuyFuel: !!settings.autoRebuyFuel,
      autoRebuyFuelUseAlert: settings.autoRebuyFuelUseAlert !== undefined ? !!settings.autoRebuyFuelUseAlert : true,
      autoRebuyFuelThreshold: parseInt(settings.autoRebuyFuelThreshold) || 400,
      autoRebuyCO2: !!settings.autoRebuyCO2,
      autoRebuyCO2UseAlert: settings.autoRebuyCO2UseAlert !== undefined ? !!settings.autoRebuyCO2UseAlert : true,
      autoRebuyCO2Threshold: parseInt(settings.autoRebuyCO2Threshold) || 7,
      autoDepartAll: !!settings.autoDepartAll,
      autoBulkRepair: !!settings.autoBulkRepair,
      autoRepairInterval: settings.autoRepairInterval || '2-3',
      autoCampaignRenewal: !!settings.autoCampaignRenewal,
      autoPilotNotifications: !!settings.autoPilotNotifications,
      autoDepartUseRouteDefaults: settings.autoDepartUseRouteDefaults !== undefined ? !!settings.autoDepartUseRouteDefaults : true,
      minVesselUtilization: parseInt(settings.minVesselUtilization) || 45,
      autoVesselSpeed: parseInt(settings.autoVesselSpeed) || 50
    };

    await fs.writeFile(SETTINGS_FILE, JSON.stringify(validSettings, null, 2), 'utf8');

    // Broadcast settings update to all connected clients
    broadcast('settings_update', validSettings);

    // Restart backend automation if repair settings changed
    if (settings.autoBulkRepair !== undefined || settings.autoRepairInterval !== undefined) {
      try {
        const backendAutomation = require('../automation');
        backendAutomation.restartAutoRepair();
      } catch (error) {
        console.error('[Settings] Failed to restart backend automation:', error);
      }
    }

    res.json({ success: true, settings: validSettings });
  } catch (error) {
    console.error('Error saving settings:', error);
    res.status(500).json({ error: 'Failed to save settings' });
  }
});

module.exports = router;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
