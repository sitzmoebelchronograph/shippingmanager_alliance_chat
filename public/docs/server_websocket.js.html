<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/websocket.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showFeedback">showFeedback</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showPriceAlert">showPriceAlert</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/websocket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview WebSocket Server and Real-Time Chat Update Management
 *
 * This module manages bidirectional real-time communication between the server and connected
 * browser clients using WebSocket protocol. It implements automatic chat feed broadcasting
 * at regular intervals to keep all connected clients synchronized with alliance chat updates.
 *
 * Key Features:
 * - WebSocket server initialization and connection lifecycle management
 * - Automatic chat feed polling every 25 seconds (configurable in config.js)
 * - Broadcast system pushing updates to all connected clients simultaneously
 * - Message transformation (converting API format to client-ready format)
 * - Company name caching to reduce API calls during message processing
 * - Graceful handling of users not in alliance (skips polling)
 *
 * Why This Architecture:
 * - HTTP polling from frontend would be inefficient and waste bandwidth
 * - Server-side polling centralizes API calls (1 API call → N clients)
 * - WebSocket enables instant push updates without client polling
 * - Automatic refresh ensures clients stay synchronized even if inactive
 * - 25-second interval balances freshness with rate limit compliance
 *
 * Message Flow:
 *   API (25s interval) → getChatFeed() → Transform Messages → Broadcast → All Clients
 *
 * WebSocket Protocol:
 * - Messages sent as JSON strings: { type: 'chat_update', data: [...messages] }
 * - Client connects via wss://localhost:12345 (secure WebSocket)
 * - Server broadcasts to all OPEN connections only (skips CONNECTING/CLOSING states)
 *
 * Rate Limiting Consideration:
 * - One server-side API call every 25 seconds for all clients
 * - Without WebSocket, 10 clients would make 10 API calls every 25 seconds
 * - Centralized polling reduces API load by factor of N (number of clients)
 *
 * @requires ws - WebSocket server implementation
 * @requires ./utils/api - API helper functions (getChatFeed, getCompanyName, getAllianceId)
 * @requires ./config - Configuration constants (CHAT_REFRESH_INTERVAL)
 * @module server/websocket
 */

const WebSocket = require('ws');
const { getChatFeed, getCompanyName, getAllianceId } = require('./utils/api');
const config = require('./config');

/**
 * WebSocket server instance (shared across all connections)
 * @type {WebSocket.Server|null}
 */
let wss = null;

/**
 * Interval timer for automatic chat refresh (25-second polling)
 * @type {NodeJS.Timeout|null}
 */
let chatRefreshInterval = null;

/**
 * Initializes the WebSocket server and sets up connection event handlers.
 *
 * This function creates a WebSocket server that operates in "noServer" mode, meaning
 * it shares the HTTPS server's port rather than opening a separate port. The upgrade
 * from HTTP to WebSocket happens via the HTTP server's 'upgrade' event (handled in app.js).
 *
 * Why noServer Mode:
 * - Shares HTTPS port 12345 instead of requiring separate WebSocket port
 * - Simplifies firewall configuration (one port instead of two)
 * - Works seamlessly with HTTPS and self-signed certificates
 * - Standard pattern for integrating WebSocket with Express
 *
 * Connection Lifecycle:
 * 1. Client sends HTTP Upgrade request to wss://localhost:12345
 * 2. Server upgrades connection to WebSocket protocol
 * 3. 'connection' event fires, logging "Client connected"
 * 4. Client remains connected until page close or network interruption
 * 5. 'close' event fires, logging "Client disconnected"
 *
 * Error Handling:
 * - Errors logged to console but don't crash server
 * - Clients can reconnect automatically after errors
 *
 * Side Effects:
 * - Sets module-level `wss` variable for use in broadcast()
 * - Logs connection/disconnection events to console
 *
 * @function initWebSocket
 * @param {https.Server} server - HTTPS server instance (from app.js)
 * @returns {WebSocket.Server} WebSocket server instance
 *
 * @example
 * const server = createHttpsServer(app);
 * const wss = initWebSocket(server);
 * // WebSocket server now listening for upgrade requests
 */
function initWebSocket(server) {
  wss = new WebSocket.Server({ noServer: true });

  wss.on('connection', (ws) => {
    console.log('Client connected');

    ws.on('close', () => {
      console.log('Client disconnected');
    });

    ws.on('error', (error) => {
      console.error('WebSocket error:', error.message);
    });
  });

  return wss;
}

/**
 * Broadcasts a message to all connected WebSocket clients.
 *
 * This function sends data to every client currently connected to the WebSocket server.
 * It only sends to clients in OPEN state (connected and ready), skipping clients that
 * are CONNECTING, CLOSING, or CLOSED.
 *
 * Why This Pattern:
 * - Centralized broadcast logic used by multiple features (chat updates, system notifications)
 * - Automatically skips clients in transitional states to prevent errors
 * - Type-based routing allows frontend to handle different message types appropriately
 * - JSON serialization ensures structured data transmission
 *
 * Message Format:
 * {
 *   type: 'chat_update' | 'system_notification' | ...,
 *   data: &lt;any>
 * }
 *
 * Safety Features:
 * - Early return if WebSocket server not initialized
 * - readyState check prevents sending to disconnecting clients
 * - JSON.stringify errors won't crash server (client.send handles errors)
 *
 * Use Cases:
 * - Chat feed updates every 25 seconds
 * - New message notifications
 * - System status updates
 * - Real-time game state changes
 *
 * @function broadcast
 * @param {string} type - Message type for client-side routing (e.g., 'chat_update')
 * @param {*} data - Payload data (will be JSON serialized)
 * @returns {void}
 *
 * @example
 * broadcast('chat_update', [
 *   { type: 'chat', company: 'ABC Corp', message: 'Hello!' }
 * ]);
 * // Sends to all connected clients:
 * // {"type":"chat_update","data":[{"type":"chat",...}]}
 *
 * @example
 * broadcast('system_notification', { message: 'Server restarting in 5 minutes' });
 */
function broadcast(type, data) {
  if (!wss) return;

  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({ type, data }));
    }
  });
}

/**
 * Starts automatic chat feed polling and broadcasting to all connected clients.
 *
 * This function implements server-side polling of the alliance chat feed at regular intervals
 * (25 seconds by default). It fetches chat messages from the game API, transforms them into
 * a client-friendly format, and broadcasts updates to all connected WebSocket clients.
 *
 * Why Server-Side Polling:
 * - Centralizes API calls (one call serves all clients)
 * - Reduces game API load compared to per-client polling
 * - Ensures all clients stay synchronized with same data
 * - Complies with rate limiting (30 req/min across all clients)
 * - Clients receive updates even when browser tab is inactive
 *
 * Polling Interval:
 * - Default: 25 seconds (config.CHAT_REFRESH_INTERVAL)
 * - Balances freshness with API rate limits
 * - 25s = 2.4 calls/minute, well below 30 req/min limit
 * - Leaves headroom for manual chat sends and other API operations
 *
 * Message Types Handled:
 * 1. Chat Messages (type: 'chat')
 *    - Fetches company name via getCompanyName() with caching
 *    - Converts Unix timestamp to UTC string
 *    - Includes user_id for sender identification
 *
 * 2. Feed Events (type: 'feed')
 *    - Alliance member joins, route completions, etc.
 *    - Already includes company name in replacements
 *    - No additional API call needed
 *
 * No Alliance Handling:
 * - Checks getAllianceId() every interval
 * - If null (user not in alliance), skips API call
 * - Prevents 404 errors from alliance-specific endpoints
 * - Allows app to work for non-alliance users
 *
 * Error Handling:
 * - API errors logged but don't stop polling
 * - Interval continues running even if one fetch fails
 * - Prevents cascading failures from transient network issues
 *
 * Side Effects:
 * - Makes API call to /alliance/get-feed every 25 seconds
 * - May make multiple API calls to /user/get-user-settings for uncached company names
 * - Broadcasts to all connected WebSocket clients
 * - Sets module-level chatRefreshInterval variable
 *
 * @function startChatAutoRefresh
 * @returns {void}
 *
 * @example
 * // Called from app.js during server initialization
 * startChatAutoRefresh();
 * // Begins polling every 25 seconds
 * // Broadcasts chat_update messages to all connected clients
 *
 * @example
 * // Typical broadcast message structure:
 * {
 *   type: 'chat_update',
 *   data: [
 *     {
 *       type: 'chat',
 *       company: 'ABC Shipping',
 *       message: 'Hello everyone!',
 *       timestamp: 'Mon, 23 Oct 2025 14:30:00 GMT',
 *       user_id: 12345
 *     },
 *     {
 *       type: 'feed',
 *       feedType: 'alliance_member_joined',
 *       company: 'XYZ Corp',
 *       timestamp: 'Mon, 23 Oct 2025 14:25:00 GMT'
 *     }
 *   ]
 * }
 */
function startChatAutoRefresh() {
  chatRefreshInterval = setInterval(async () => {
    if (!getAllianceId()) {
      return;
    }

    try {
      const feed = await getChatFeed();
      const messages = [];

      for (const msg of feed) {
        if (msg.type === 'chat') {
          const companyName = await getCompanyName(msg.user_id);
          const timestamp = new Date(msg.time_created * 1000).toUTCString();
          messages.push({
            type: 'chat',
            company: companyName,
            message: msg.message,
            timestamp: timestamp,
            user_id: msg.user_id
          });
        } else if (msg.type === 'feed') {
          const timestamp = new Date(msg.time_created * 1000).toUTCString();
          messages.push({
            type: 'feed',
            feedType: msg.feed_type,
            company: msg.replacements.company_name,
            timestamp: timestamp
          });
        }
      }

      if (messages.length > 0 || wss.clients.size > 0) {
        broadcast('chat_update', messages);
      }
    } catch (error) {
      console.error('Auto-refresh error:', error.message);
    }
  }, config.CHAT_REFRESH_INTERVAL);
}

/**
 * Stops the automatic chat feed polling and clears the interval timer.
 *
 * This function provides a clean shutdown mechanism for the chat auto-refresh feature.
 * It's primarily used during server shutdown or when temporarily disabling automatic updates.
 *
 * Why This Matters:
 * - Prevents interval from continuing after server shutdown
 * - Cleans up resources properly to avoid memory leaks
 * - Allows pausing auto-refresh without restarting server
 * - Sets interval reference to null for garbage collection
 *
 * Use Cases:
 * - Server graceful shutdown (SIGTERM/SIGINT handlers)
 * - Temporarily disabling auto-refresh for maintenance
 * - Reconfiguring refresh interval (stop, then restart with new interval)
 *
 * Side Effects:
 * - Clears the setInterval timer
 * - Sets chatRefreshInterval to null
 * - No more automatic broadcasts until startChatAutoRefresh() called again
 *
 * @function stopChatAutoRefresh
 * @returns {void}
 *
 * @example
 * // During server shutdown
 * process.on('SIGTERM', () => {
 *   console.log('Shutting down server...');
 *   stopChatAutoRefresh();
 *   server.close();
 * });
 *
 * @example
 * // Reconfiguring refresh interval
 * stopChatAutoRefresh();
 * config.CHAT_REFRESH_INTERVAL = 30000; // Change to 30 seconds
 * startChatAutoRefresh();
 */
function stopChatAutoRefresh() {
  if (chatRefreshInterval) {
    clearInterval(chatRefreshInterval);
    chatRefreshInterval = null;
  }
}

module.exports = {
  initWebSocket,
  broadcast,
  startChatAutoRefresh,
  stopChatAutoRefresh
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
