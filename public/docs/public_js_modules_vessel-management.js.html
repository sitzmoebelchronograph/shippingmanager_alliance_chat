<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/vessel-management.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#express">express</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/vessel-management.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Vessel Management Module - Handles all vessel-related operations including purchasing,
 * departures, bulk repair, and vessel catalog browsing with filtering.
 *
 * Key Features:
 * - Vessel count tracking (ready to depart, at anchor, pending delivery)
 * - Bulk departure with fuel/CO2 consumption and income calculation
 * - Bulk repair system with wear threshold filtering
 * - Vessel catalog with container/tanker filtering
 * - Engine type filtering for specialized searches
 * - Multi-vessel purchase with confirmation and sequential API calls
 * - Stock price display for IPO companies
 * - Pending vessel tracking with delivery countdown
 *
 * Purchase Flow:
 * - Single purchase: Click "Buy Now" for immediate purchase
 * - Bulk purchase: Select multiple vessels, click "Bulk Buy"
 * - Sequential API calls with 1.5s delay to prevent rate limiting
 * - Cash updates after each successful purchase
 * - Auto-stops on limit reached or insufficient funds
 *
 * Departure System:
 * - Departs all vessels in "port" status simultaneously
 * - Calculates fuel consumption and CO2 emissions
 * - Shows income from vessel departures minus harbor fees
 * - Updates bunker inventory immediately for UX responsiveness
 * - Refreshes vessel and bunker status after completion
 *
 * Repair System:
 * - Filters vessels by wear percentage threshold (user configurable)
 * - Fetches repair costs for all qualifying vessels
 * - Shows total cost with affordability check
 * - Bulk repair via single API call
 *
 * @module vessel-management
 * @requires utils - Formatting and feedback functions
 * @requires api - Vessel API endpoints
 * @requires ui-dialogs - Confirmation dialogs
 * @requires bunker-management - Cash and fuel inventory management
 */

import { formatNumber, showSideNotification } from './utils.js';
import { escapeHtml } from './utils.js';
import {
  fetchVessels,
  fetchUserSettings,
  departAllVessels as apiDepartAllVessels,
  fetchAcquirableVessels,
  purchaseVessel as apiPurchaseVessel,
  getMaintenanceCost,
  doWearMaintenanceBulk
} from './api.js';
import { showConfirmDialog } from './ui-dialogs.js';
import { getCurrentBunkerState, updateCurrentCash, updateCurrentFuel, updateCurrentCO2 } from './bunker-management.js';

/**
 * Array of all vessels available for purchase.
 * Populated from API and filtered by type/engine for display.
 * @type {Array&lt;Object>}
 */
let allAcquirableVessels = [];

/**
 * Current vessel type filter: 'container' or 'tanker'.
 * @type {string}
 */
let currentVesselFilter = 'container';

/**
 * Current engine type filter (null shows all engines).
 * Populated from unique engine types in vessel catalog.
 * @type {string|null}
 */
let selectedEngineType = null;

/**
 * Array of selected vessels for bulk purchase.
 * Each item contains vessel object and quantity.
 * @type {Array&lt;{vessel: Object, quantity: number}>}
 */
let selectedVessels = [];

/**
 * Updates vessel count badges and status displays for different vessel states.
 * Fetches current vessel data and updates UI badges for ready-to-depart, at-anchor, and pending vessels.
 *
 * Vessel States:
 * - 'port': Ready to depart (shows on depart button badge)
 * - 'anchor': At anchor waiting for route planning (shows on anchor button)
 * - 'pending': Vessel purchased but not yet delivered (shows delivery countdown)
 *
 * Additional Data Updates:
 * - Anchor capacity: Available slots vs maximum
 * - Stock price: For companies that have gone IPO
 * - Stock trend: Up/down indicator
 *
 * Side Effects:
 * - Fetches vessel and user settings data from API
 * - Updates multiple DOM badges and displays
 * - Enables/disables buttons based on vessel availability
 * - Updates button tooltips with contextual information
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Called automatically every 30-35 seconds
 * updateVesselCount();
 */
export async function updateVesselCount() {
  try {
    const data = await fetchVessels();
    const vessels = data.vessels || [];

    const readyToDepart = vessels.filter(v => v.status === 'port').length;
    const atAnchor = vessels.filter(v => v.status === 'anchor').length;
    const pendingVessels = vessels.filter(v => v.status === 'pending').length;

    const pendingBadge = document.getElementById('pendingVesselsBadge');
    if (pendingBadge) {
      if (pendingVessels > 0) {
        pendingBadge.textContent = pendingVessels;
        pendingBadge.style.display = 'block';
      } else {
        pendingBadge.style.display = 'none';
      }
    }

    const pendingBtn = document.getElementById('filterPendingBtn');
    const pendingCountSpan = document.getElementById('pendingCount');
    if (pendingBtn &amp;&amp; pendingCountSpan) {
      if (pendingVessels > 0) {
        pendingCountSpan.textContent = pendingVessels;
        pendingBtn.style.display = 'block';
      } else {
        pendingBtn.style.display = 'none';
      }
    }

    const countBadge = document.getElementById('vesselCount');
    const departBtn = document.getElementById('departAllBtn');

    if (readyToDepart > 0) {
      countBadge.textContent = readyToDepart;
      countBadge.style.display = 'block';
      departBtn.disabled = false;
      departBtn.title = `Depart all ${readyToDepart} vessel${readyToDepart === 1 ? '' : 's'} from harbor`;
    } else {
      countBadge.style.display = 'none';
      departBtn.disabled = true;
      departBtn.title = 'No vessels ready to depart';
    }

    const anchorBadge = document.getElementById('anchorCount');
    const anchorBtn = document.getElementById('anchorBtn');

    if (atAnchor > 0) {
      anchorBadge.textContent = atAnchor;
      anchorBadge.style.display = 'block';
      anchorBtn.disabled = false;
      anchorBtn.title = `${atAnchor} vessel${atAnchor === 1 ? '' : 's'} at anchor`;
    } else {
      anchorBadge.style.display = 'none';
      anchorBtn.disabled = true;
      anchorBtn.title = 'No vessels at anchor';
    }

    const settingsResponse = await fetchUserSettings();
    if (settingsResponse) {
      const maxAnchorPoints = settingsResponse.data?.settings?.anchor_points || 0;
      const stockValue = settingsResponse.user?.stock_value || 0;
      const stockTrend = settingsResponse.user?.stock_trend || '';

      const totalVessels = vessels.length;
      const availableCapacity = maxAnchorPoints - totalVessels;

      const anchorSlotsDisplay = document.getElementById('anchorSlotsDisplay');
      if (anchorSlotsDisplay) {
        anchorSlotsDisplay.textContent = `${availableCapacity}/${maxAnchorPoints}`;
      }

      const stockDisplay = document.getElementById('stockDisplay');
      const stockTrendElement = document.getElementById('stockTrend');
      const ipo = settingsResponse.user?.ipo || 0;

      if (stockDisplay &amp;&amp; stockTrendElement) {
        const stockContainer = stockDisplay.parentElement;

        if (ipo === 1) {
          stockContainer.style.display = 'flex';
          stockDisplay.textContent = stockValue.toFixed(2);

          if (stockTrend === 'up') {
            stockTrendElement.textContent = '↑';
            stockTrendElement.style.color = '#4ade80';
          } else if (stockTrend === 'down') {
            stockTrendElement.textContent = '↓';
            stockTrendElement.style.color = '#ef4444';
          } else {
            stockTrendElement.textContent = '';
          }
        } else {
          stockContainer.style.display = 'none';
        }
      }
    }
  } catch (error) {
    console.error('Error updating vessel count:', error);
  }
}

/**
 * Departs all vessels currently in harbor (status 'port').
 * Calculates and displays fuel usage, CO2 emissions, income, and harbor fees.
 *
 * Departure Process:
 * 1. Disables depart button to prevent double-click
 * 2. Calls API to depart all ready vessels
 * 3. Extracts resource usage and income from response
 * 4. Updates local cash/fuel/CO2 immediately for UX
 * 5. Triggers delayed refresh of vessel and bunker displays
 * 6. Shows detailed price alert with departure summary
 *
 * Partial Departure Handling:
 * - If not all vessels departed (insufficient fuel): Shows error with count
 * - If no vessels departed: Shows critical error message
 * - If all departed successfully: Shows success message with details
 *
 * Resource Updates:
 * - Cash: Increased by (depart_income - harbor_fee)
 * - Fuel: Decreased by fuel_usage
 * - CO2: Decreased by co2_emission
 *
 * Side Effects:
 * - Makes API call to depart vessels
 * - Updates bunker state (cash, fuel, CO2)
 * - Triggers debounced vessel and bunker status updates
 * - Shows price alert with departure details
 * - Disables button during operation
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // User clicks "Depart All" button
 * departAllVessels();
 * // Shows: "5 vessels departed! Fuel: 150t, CO2: 45t, Net income: $125,000"
 */
export async function departAllVessels() {
  const departBtn = document.getElementById('departAllBtn');
  const vesselCountBadge = document.getElementById('vesselCount');
  const vesselsInHarbor = parseInt(vesselCountBadge.textContent) || 0;

  departBtn.disabled = true;

  try {
    const data = await apiDepartAllVessels();

    if (data.error) {
      showSideNotification(`&lt;strong>Error&lt;/strong>&lt;br>&lt;br>${data.error}`, 'error', null, true);
      departBtn.disabled = false;
      return;
    }

    const vesselsDeparted = data.data?.depart_info?.vessel_count || 0;
    const fuelUsed = (data.data?.depart_info?.fuel_usage || 0) / 1000;
    const co2Emitted = (data.data?.depart_info?.co2_emission || 0) / 1000;
    const departIncome = data.data?.depart_info?.depart_income || 0;
    const harborFee = data.data?.depart_info?.harbor_fee || 0;

    const bunkerState = getCurrentBunkerState();
    const netIncome = departIncome - harborFee;
    updateCurrentCash(bunkerState.currentCash + netIncome);
    updateCurrentFuel(bunkerState.currentFuel - fuelUsed);
    updateCurrentCO2(bunkerState.currentCO2 - co2Emitted);

    if (window.debouncedUpdateVesselCount &amp;&amp; window.debouncedUpdateBunkerStatus) {
      setTimeout(() => window.debouncedUpdateVesselCount(800), 1000);
      setTimeout(() => window.debouncedUpdateBunkerStatus(800), 1200);
    }

    if (vesselsDeparted === 0) {
      showSideNotification('🚢 &lt;strong>No vessels could depart!&lt;/strong>&lt;br>&lt;br>Check fuel availability.', 'error', null, true);
    } else if (vesselsDeparted &lt; vesselsInHarbor) {
      const vesselsRemaining = vesselsInHarbor - vesselsDeparted;
      showSideNotification(`🚢 &lt;strong>Only ${vesselsDeparted} of ${vesselsInHarbor} vessels departed!&lt;/strong>&lt;br>&lt;br>${vesselsRemaining} vessels remaining in harbor&lt;br>⛽ Fuel used: ${formatNumber(fuelUsed)}t&lt;br>💨 CO2 emitted: ${formatNumber(co2Emitted)}t&lt;br>💰 Net income: $${formatNumber(netIncome)}&lt;br>&lt;span style="opacity: 0.7; font-size: 0.9em;">(Income: $${formatNumber(departIncome)} - Fee: $${formatNumber(harborFee)})&lt;/span>`, 'error', null, true);
    } else {
      showSideNotification(`🚢 &lt;strong>All ${vesselsDeparted} vessel${vesselsDeparted === 1 ? '' : 's'} departed!&lt;/strong>&lt;br>&lt;br>⛽ Fuel used: ${formatNumber(fuelUsed)}t&lt;br>💨 CO2 emitted: ${formatNumber(co2Emitted)}t&lt;br>💰 Net income: $${formatNumber(netIncome)}&lt;br>&lt;span style="opacity: 0.7; font-size: 0.9em;">(Income: $${formatNumber(departIncome)} - Fee: $${formatNumber(harborFee)})&lt;/span>`, 'success', null, true);
    }

  } catch (error) {
    showSideNotification(`&lt;strong>Error&lt;/strong>&lt;br>&lt;br>${error.message}`, 'error', null, true);
    departBtn.disabled = false;
  }
}

export async function updateRepairCount(settings) {
  try {
    const data = await fetchVessels();
    const vessels = data.vessels || [];

    const vesselsNeedingRepair = vessels.filter(v => {
      const wear = parseInt(v.wear) || 0;
      return wear >= settings.maintenanceThreshold;
    });

    const countBadge = document.getElementById('repairCount');
    const repairBtn = document.getElementById('repairAllBtn');

    if (vesselsNeedingRepair.length > 0) {
      countBadge.textContent = vesselsNeedingRepair.length;
      countBadge.style.display = 'block';
      repairBtn.disabled = false;
      repairBtn.title = `Repair ${vesselsNeedingRepair.length} vessel${vesselsNeedingRepair.length === 1 ? '' : 's'} with ${settings.maintenanceThreshold}%+ wear`;
    } else {
      countBadge.style.display = 'none';
      repairBtn.disabled = true;
      repairBtn.title = `No vessels with ${settings.maintenanceThreshold}%+ wear`;
    }
  } catch (error) {
    console.error('Error updating repair count:', error);
  }
}

/**
 * Repairs all vessels with wear at or above the configured maintenance threshold.
 * Shows confirmation dialog with total cost and processes bulk repair.
 *
 * Repair Flow:
 * 1. Fetch current vessels from API
 * 2. Filter vessels by wear threshold from settings
 * 3. Get repair cost estimate for all qualifying vessels
 * 4. Check affordability (cash >= total cost)
 * 5. Show confirmation dialog with cost breakdown
 * 6. Process bulk repair API call
 * 7. Update bunker status and repair count displays
 *
 * Cost Calculation:
 * - Fetches maintenance data for each vessel
 * - Sums "wear" type maintenance costs
 * - Compares against current cash
 *
 * Side Effects:
 * - Fetches vessel and maintenance cost data
 * - Shows confirmation dialog
 * - Makes bulk repair API call
 * - Updates cash via bunker state
 * - Triggers debounced status updates
 * - Shows success/error feedback
 * - Disables button during operation
 *
 * @async
 * @param {Object} settings - User settings object
 * @param {number} settings.maintenanceThreshold - Minimum wear percentage to trigger repair
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Repairs all vessels with 10%+ wear
 * repairAllVessels({ maintenanceThreshold: 10 });
 */
export async function repairAllVessels(settings) {
  const repairBtn = document.getElementById('repairAllBtn');
  const repairCountBadge = document.getElementById('repairCount');
  const vesselsNeedingRepair = parseInt(repairCountBadge.textContent) || 0;

  if (vesselsNeedingRepair === 0) return;

  try {
    const data = await fetchVessels();
    const vessels = data.vessels || [];

    const vesselsToRepair = vessels.filter(v => {
      const wear = parseInt(v.wear) || 0;
      return wear >= settings.maintenanceThreshold;
    });

    if (vesselsToRepair.length === 0) {
      showSideNotification('🔧 No vessels need repair!', 'info');
      return;
    }

    const vesselIds = vesselsToRepair.map(v => v.id);
    const costData = await getMaintenanceCost(vesselIds);

    let totalCost = 0;
    if (costData.data?.vessels) {
      costData.data.vessels.forEach(vessel => {
        const wearMaintenance = vessel.maintenance_data?.find(m => m.type === 'wear');
        if (wearMaintenance) {
          totalCost += wearMaintenance.price || 0;
        }
      });
    }

    const bunkerState = getCurrentBunkerState();
    if (totalCost > bunkerState.currentCash) {
      showSideNotification(`🔧 &lt;strong>Not enough cash!&lt;/strong>&lt;br>&lt;br>Repair cost: $${formatNumber(totalCost)}&lt;br>Your cash: $${formatNumber(bunkerState.currentCash)}&lt;br>Missing: $${formatNumber(totalCost - bunkerState.currentCash)}`, 'error', null, true);
      return;
    }

    const confirmed = await showConfirmDialog({
      title: '🔧 Bulk Vessel Repair',
      message: `Do you want to repair all vessels with ${settings.maintenanceThreshold}%+ wear?`,
      confirmText: 'Repair All',
      details: [
        { label: 'Vessels to repair', value: `${vesselsToRepair.length}` },
        { label: 'Wear threshold', value: `${settings.maintenanceThreshold}%` },
        { label: 'Total Cost', value: `$${formatNumber(totalCost)}` },
        { label: 'Available Cash', value: `$${formatNumber(bunkerState.currentCash)}` }
      ]
    });

    if (!confirmed) return;

    repairBtn.disabled = true;

    const repairData = await doWearMaintenanceBulk(vesselIds);

    if (repairData.error) {
      showSideNotification(`&lt;strong>Error&lt;/strong>&lt;br>&lt;br>${repairData.error}`, 'error', null, true);
      repairBtn.disabled = false;
      return;
    }

    showSideNotification(`🔧 &lt;strong>${vesselsToRepair.length} vessels repaired!&lt;/strong>&lt;br>&lt;br>💰 Total cost: $${formatNumber(totalCost)}&lt;br>🔧 Wear threshold: ${settings.maintenanceThreshold}%`, 'success');

    if (window.debouncedUpdateRepairCount &amp;&amp; window.debouncedUpdateBunkerStatus) {
      setTimeout(() => window.debouncedUpdateRepairCount(800), 1000);
      setTimeout(() => window.debouncedUpdateBunkerStatus(800), 1200);
    }

  } catch (error) {
    showSideNotification(`&lt;strong>Error&lt;/strong>&lt;br>&lt;br>${error.message}`, 'error', null, true);
    repairBtn.disabled = false;
  }
}

export async function loadAcquirableVessels() {
  try {
    const data = await fetchAcquirableVessels();
    allAcquirableVessels = data.data.vessels_for_sale || [];
    displayVessels();
  } catch (error) {
    console.error('Error loading vessels:', error);
    document.getElementById('vesselCatalogFeed').innerHTML = `
      &lt;div style="text-align: center; color: #ef4444; padding: 40px;">
        Failed to load vessels. Please try again.
      &lt;/div>
    `;
  }
}

function getCapacityDisplay(vessel) {
  if (typeof vessel.capacity_max === 'object' &amp;&amp; vessel.capacity_max !== null) {
    if (vessel.capacity_type === 'container') {
      const dry = vessel.capacity_max.dry || 0;
      const refrigerated = vessel.capacity_max.refrigerated || 0;
      const total = dry + refrigerated;
      return `Dry: ${formatNumber(dry)} TEU + Refrigerated: ${formatNumber(refrigerated)} TEU = &lt;strong>${formatNumber(total)} TEU&lt;/strong>`;
    } else {
      const crudeOil = vessel.capacity_max.crude_oil || 0;
      const fuel = vessel.capacity_max.fuel || 0;
      const total = crudeOil + fuel;
      return `Crude Oil: ${formatNumber(crudeOil)} BBL + Fuel: ${formatNumber(fuel)} BBL = &lt;strong>${formatNumber(total)} BBL&lt;/strong>`;
    }
  } else {
    const value = vessel.capacity_max || 0;
    const unit = vessel.capacity_type === 'container' ? 'TEU' : 'BBL';
    return `${formatNumber(value)} ${unit}`;
  }
}

function getEfficiencyColor(factor) {
  if (factor &lt; 1.0) return '#4ade80'; // green
  if (factor === 1.0) return '#9ca3af'; // gray
  return '#fb923c'; // orange
}

export function showPendingVessels(pendingVessels) {
  const feed = document.getElementById('vesselCatalogFeed');

  document.getElementById('filterContainerBtn').classList.remove('active');
  document.getElementById('filterTankerBtn').classList.remove('active');
  document.getElementById('filterEngineBtn').classList.remove('active');
  document.getElementById('filterPendingBtn').classList.add('active');

  const bulkBtn = document.getElementById('bulkBuyBtn');
  if (bulkBtn) bulkBtn.style.display = 'none';

  if (pendingVessels.length === 0) {
    feed.innerHTML = `
      &lt;div style="text-align: center; color: #9ca3af; padding: 40px;">
        No pending vessels
      &lt;/div>
    `;
    return;
  }

  const grid = document.createElement('div');
  grid.className = 'vessel-catalog-grid';

  pendingVessels.forEach(vessel => {
    const imageUrl = `https://shippingmanager.cc/images/acquirevessels/${vessel.type}`;

    let timeDisplay = '';
    const remaining = vessel.time_arrival || 0;

    if (remaining > 0) {
      const days = Math.floor(remaining / 86400);
      const hours = Math.floor((remaining % 86400) / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      if (days > 0) {
        timeDisplay = `${days}d ${hours}h`;
      } else if (hours > 0) {
        timeDisplay = `${hours}h ${minutes}m`;
      } else {
        timeDisplay = `${minutes}m`;
      }
    } else {
      timeDisplay = 'Ready';
    }

    const capacityDisplay = getCapacityDisplay(vessel);
    const co2Color = getEfficiencyColor(vessel.co2_factor || 1);
    const fuelColor = getEfficiencyColor(vessel.fuel_factor || 1);

    let additionalAttrs = '';
    if (vessel.width &amp;&amp; vessel.width !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Width:&lt;/strong> ${vessel.width} m&lt;/div>`;
    }
    if (vessel.price_in_points &amp;&amp; vessel.price_in_points !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Points Price:&lt;/strong> ${formatNumber(vessel.price_in_points)}&lt;/div>`;
    }
    if (vessel.perks &amp;&amp; vessel.perks !== null) {
      additionalAttrs += `&lt;div class="vessel-spec" style="grid-column: 1 / -1;">&lt;strong>Perks:&lt;/strong> ${vessel.perks}&lt;/div>`;
    }

    const card = document.createElement('div');
    card.className = 'vessel-card pending-vessel';
    card.innerHTML = `
      &lt;div style="position: relative;">
        &lt;img src="${imageUrl}" alt="${vessel.name}" class="vessel-image" onerror="this.src='data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22>&lt;rect fill=%22%23374151%22 width=%22400%22 height=%22300%22/>&lt;text x=%2250%%22 y=%2250%%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 font-size=%2224%22>⛴️&lt;/text>&lt;/svg>'">
        ${vessel.only_for_credits ? '&lt;div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; font-size: 80px; font-weight: 900; text-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.8);">$&lt;/div>' : ''}
        &lt;div style="position: absolute; top: 8px; left: 8px; background: rgba(249, 115, 22, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 13px; font-weight: 600;">⏱️ ${timeDisplay}&lt;/div>
        &lt;div style="position: absolute; bottom: 8px; right: 8px; background: rgba(16, 185, 129, 0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 13px; font-weight: 600;">$${formatNumber(vessel.price || 0)}&lt;/div>
      &lt;/div>
      &lt;div class="vessel-content">
        &lt;div class="vessel-header">
          &lt;h3 class="vessel-name">${vessel.name}&lt;/h3>
        &lt;/div>
        &lt;div class="vessel-specs">
          &lt;div class="vessel-spec">&lt;strong>Type:&lt;/strong> ${vessel.type_name || vessel.type}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Year:&lt;/strong> ${vessel.year || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec" style="grid-column: 1 / -1;">&lt;strong>Capacity:&lt;/strong> ${capacityDisplay}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>IMO:&lt;/strong> ${vessel.imo || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>MMSI:&lt;/strong> ${vessel.mmsi || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Speed:&lt;/strong> ${vessel.max_speed || 0} kn&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Range:&lt;/strong> ${formatNumber(vessel.range || 0)} nm&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Engine:&lt;/strong> ${vessel.engine_type || 'N/A'} (${formatNumber(vessel.kw || 0)} kW)&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Length:&lt;/strong> ${vessel.length || 0} m&lt;/div>
          &lt;div class="vessel-spec" style="color: ${co2Color};">&lt;strong>CO2 Factor:&lt;/strong> ${vessel.co2_factor || 1}&lt;/div>
          &lt;div class="vessel-spec" style="color: ${fuelColor};">&lt;strong>Fuel Factor:&lt;/strong> ${vessel.fuel_factor || 1}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Fuel Cap.:&lt;/strong> ${formatNumber(vessel.fuel_capacity || 0)} t&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Service:&lt;/strong> ${vessel.hours_between_service || 0}h&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Port:&lt;/strong> ${(vessel.current_port_code || '').replace(/_/g, ' ')}&lt;/div>
          ${vessel.gearless || vessel.antifouling || additionalAttrs ? '&lt;div class="vessel-spec" style="grid-column: 1 / -1; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 8px; padding-top: 8px;">&lt;/div>' : ''}
          ${vessel.gearless ? '&lt;div class="vessel-spec" style="grid-column: 1 / -1; color: #4ade80;">&lt;strong>⚙️ Gearless:&lt;/strong> own cranes&lt;/div>' : ''}
          ${vessel.antifouling ? `&lt;div class="vessel-spec" style="grid-column: 1 / -1; color: #a78bfa;">&lt;strong>🛡️ Antifouling:&lt;/strong> ${vessel.antifouling}&lt;/div>` : ''}
          ${additionalAttrs}
        &lt;/div>
      &lt;/div>
    `;
    grid.appendChild(card);
  });

  feed.innerHTML = '';
  feed.appendChild(grid);
}

export function displayVessels() {
  const feed = document.getElementById('vesselCatalogFeed');

  let filtered;

  if (selectedEngineType) {
    filtered = allAcquirableVessels.filter(v => v.engine_type === selectedEngineType);
  } else {
    filtered = allAcquirableVessels.filter(v => v.capacity_type === currentVesselFilter);
  }

  if (filtered.length === 0) {
    const filterText = selectedEngineType
      ? `No vessels with engine type "${selectedEngineType}"`
      : `No ${currentVesselFilter} vessels available`;
    feed.innerHTML = `
      &lt;div style="text-align: center; color: #9ca3af; padding: 40px;">
        ${filterText}
      &lt;/div>
    `;
    return;
  }

  filtered.sort((a, b) => a.price - b.price);

  const grid = document.createElement('div');
  grid.className = 'vessel-catalog-grid';

  filtered.forEach(vessel => {
    const selectedItem = selectedVessels.find(v => v.vessel.id === vessel.id);
    const isSelected = !!selectedItem;
    const imageUrl = `https://shippingmanager.cc/images/acquirevessels/${vessel.type}`;

    const capacityDisplay = getCapacityDisplay(vessel);
    const co2Color = getEfficiencyColor(vessel.co2_factor || 1);
    const fuelColor = getEfficiencyColor(vessel.fuel_factor || 1);

    let additionalAttrs = '';
    if (vessel.width &amp;&amp; vessel.width !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Width:&lt;/strong> ${vessel.width} m&lt;/div>`;
    }
    if (vessel.price_in_points &amp;&amp; vessel.price_in_points !== 0) {
      additionalAttrs += `&lt;div class="vessel-spec">&lt;strong>Points Price:&lt;/strong> ${formatNumber(vessel.price_in_points)}&lt;/div>`;
    }
    if (vessel.perks &amp;&amp; vessel.perks !== null) {
      additionalAttrs += `&lt;div class="vessel-spec" style="grid-column: 1 / -1;">&lt;strong>Perks:&lt;/strong> ${vessel.perks}&lt;/div>`;
    }

    const card = document.createElement('div');
    card.className = `vessel-card${isSelected ? ' selected' : ''}`;
    card.innerHTML = `
      &lt;div style="position: relative;">
        &lt;img src="${imageUrl}" alt="${vessel.name}" class="vessel-image" onerror="this.src='data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 300%22>&lt;rect fill=%22%23374151%22 width=%22400%22 height=%22300%22/>&lt;text x=%2250%%22 y=%2250%%22 fill=%22%239ca3af%22 text-anchor=%22middle%22 font-size=%2224%22>⛴️&lt;/text>&lt;/svg>'">
        ${vessel.only_for_credits ? '&lt;div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; font-size: 80px; font-weight: 900; text-shadow: 0 0 20px rgba(0,0,0,0.8), 0 0 40px rgba(0,0,0,0.8);">$&lt;/div>' : ''}
      &lt;/div>
      &lt;div class="vessel-content">
        &lt;div class="vessel-header">
          &lt;h3 class="vessel-name">${vessel.name}&lt;/h3>
          &lt;div class="vessel-price">$${formatNumber(vessel.price)}&lt;/div>
        &lt;/div>
        &lt;div class="vessel-specs">
          &lt;div class="vessel-spec">&lt;strong>Type:&lt;/strong> ${vessel.type_name}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Year:&lt;/strong> ${vessel.year}&lt;/div>
          &lt;div class="vessel-spec" style="grid-column: 1 / -1;">&lt;strong>Capacity:&lt;/strong> ${capacityDisplay}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>IMO:&lt;/strong> ${vessel.imo || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>MMSI:&lt;/strong> ${vessel.mmsi || 'N/A'}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Speed:&lt;/strong> ${vessel.max_speed} kn&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Range:&lt;/strong> ${formatNumber(vessel.range)} nm&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Engine:&lt;/strong> ${vessel.engine_type} (${formatNumber(vessel.kw)} kW)&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Length:&lt;/strong> ${vessel.length} m&lt;/div>
          &lt;div class="vessel-spec" style="color: ${co2Color};">&lt;strong>CO2 Factor:&lt;/strong> ${vessel.co2_factor || 1}&lt;/div>
          &lt;div class="vessel-spec" style="color: ${fuelColor};">&lt;strong>Fuel Factor:&lt;/strong> ${vessel.fuel_factor || 1}&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Fuel Cap.:&lt;/strong> ${formatNumber(vessel.fuel_capacity)} t&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Service:&lt;/strong> ${vessel.hours_between_service}h&lt;/div>
          &lt;div class="vessel-spec">&lt;strong>Port:&lt;/strong> ${vessel.current_port_code.replace(/_/g, ' ')}&lt;/div>
          ${vessel.gearless || vessel.antifouling || additionalAttrs ? '&lt;div class="vessel-spec" style="grid-column: 1 / -1; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 8px; padding-top: 8px;">&lt;/div>' : ''}
          ${vessel.gearless ? '&lt;div class="vessel-spec" style="grid-column: 1 / -1; color: #4ade80;">&lt;strong>⚙️ Gearless:&lt;/strong> own cranes&lt;/div>' : ''}
          ${vessel.antifouling ? `&lt;div class="vessel-spec" style="grid-column: 1 / -1; color: #a78bfa;">&lt;strong>🛡️ Antifouling:&lt;/strong> ${vessel.antifouling}&lt;/div>` : ''}
          ${additionalAttrs}
        &lt;/div>
        &lt;div class="vessel-actions">
          &lt;input type="number" class="vessel-quantity-input" data-vessel-id="${vessel.id}" value="${isSelected ? selectedItem.quantity : 1}" min="1" max="99" />
          &lt;div class="vessel-action-buttons">
            &lt;button class="vessel-select-btn${isSelected ? ' selected' : ''}" data-vessel-id="${vessel.id}">
              ${isSelected ? `✓ Selected (${selectedItem.quantity}x)` : 'Select'}
            &lt;/button>
            &lt;button class="vessel-buy-btn" data-vessel-id="${vessel.id}">
              Buy Now
            &lt;/button>
          &lt;/div>
        &lt;/div>
      &lt;/div>
    `;

    card.querySelector('.vessel-select-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      toggleVesselSelection(vessel, quantity);
    });
    card.querySelector('.vessel-buy-btn').addEventListener('click', () => {
      const quantityInput = card.querySelector('.vessel-quantity-input');
      const quantity = parseInt(quantityInput.value) || 1;
      purchaseSingleVessel(vessel, quantity);
    });

    grid.appendChild(card);
  });

  feed.innerHTML = '';
  feed.appendChild(grid);
}

export function showEngineFilterOverlay() {
  const overlay = document.getElementById('engineFilterOverlay');
  const listContainer = document.getElementById('engineFilterList');

  const engineTypes = [...new Set(allAcquirableVessels.map(v => v.engine_type))].sort();

  let html = '&lt;div style="max-width: 800px; margin: 0 auto;">';

  html += `
    &lt;div class="chat-selection-item" data-engine="" style="cursor: pointer; padding: 15px; background: ${!selectedEngineType ? 'rgba(16, 185, 129, 0.2)' : 'rgba(31, 41, 55, 0.4)'}; border: 1px solid ${!selectedEngineType ? 'rgba(16, 185, 129, 0.4)' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 8px; transition: all 0.2s; margin-bottom: 10px;">
      &lt;div style="font-weight: 600; color: #e0e0e0;">All Engines&lt;/div>
      &lt;div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">Show all vessels&lt;/div>
    &lt;/div>
  `;

  html += '&lt;div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';

  engineTypes.forEach((engineType, index) => {
    const count = allAcquirableVessels.filter(v => v.engine_type === engineType).length;
    const isSelected = selectedEngineType === engineType;
    const isLastAndOdd = (index === engineTypes.length - 1) &amp;&amp; (engineTypes.length % 2 !== 0);

    html += `
      &lt;div class="chat-selection-item" data-engine="${engineType}" style="cursor: pointer; padding: 15px; background: ${isSelected ? 'rgba(16, 185, 129, 0.2)' : 'rgba(31, 41, 55, 0.4)'}; border: 1px solid ${isSelected ? 'rgba(16, 185, 129, 0.4)' : 'rgba(255, 255, 255, 0.1)'}; border-radius: 8px; transition: all 0.2s;${isLastAndOdd ? ' grid-column: 1 / -1; max-width: 50%; margin: 0 auto;' : ''}">
        &lt;div style="font-weight: 600; color: #e0e0e0;">⚙️ ${engineType}&lt;/div>
        &lt;div style="font-size: 12px; color: #9ca3af; margin-top: 4px;">${count} vessel${count === 1 ? '' : 's'} available&lt;/div>
      &lt;/div>
    `;
  });

  html += '&lt;/div>&lt;/div>';
  listContainer.innerHTML = html;

  listContainer.querySelectorAll('.chat-selection-item').forEach(item => {
    item.addEventListener('click', () => {
      const engineType = item.getAttribute('data-engine');
      selectedEngineType = engineType || null;

      if (selectedEngineType) {
        document.getElementById('filterContainerBtn').classList.remove('active');
        document.getElementById('filterTankerBtn').classList.remove('active');
        document.getElementById('filterEngineBtn').classList.add('active');
      } else {
        document.getElementById('filterEngineBtn').classList.remove('active');
        if (currentVesselFilter === 'container') {
          document.getElementById('filterContainerBtn').classList.add('active');
        } else {
          document.getElementById('filterTankerBtn').classList.add('active');
        }
      }

      overlay.style.display = 'none';
      displayVessels();
    });

    item.addEventListener('mouseenter', function() {
      if (this.getAttribute('data-engine') !== selectedEngineType) {
        this.style.background = 'rgba(31, 41, 55, 0.6)';
      }
    });

    item.addEventListener('mouseleave', function() {
      const engineType = this.getAttribute('data-engine');
      const isSelected = (!engineType &amp;&amp; !selectedEngineType) || (engineType === selectedEngineType);
      this.style.background = isSelected ? 'rgba(16, 185, 129, 0.2)' : 'rgba(31, 41, 55, 0.4)';
    });
  });

  overlay.style.display = 'flex';
}

export function closeEngineFilterOverlay() {
  document.getElementById('engineFilterOverlay').style.display = 'none';
}

function toggleVesselSelection(vessel, quantity) {
  const index = selectedVessels.findIndex(v => v.vessel.id === vessel.id);

  if (index > -1) {
    selectedVessels.splice(index, 1);
  } else {
    selectedVessels.push({ vessel, quantity });
  }

  const totalCount = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);
  const selectedCountEl = document.getElementById('selectedCount');
  const bulkBuyBtn = document.getElementById('bulkBuyBtn');

  if (selectedCountEl) selectedCountEl.textContent = totalCount;
  if (bulkBuyBtn) bulkBuyBtn.style.display = selectedVessels.length > 0 ? 'block' : 'none';

  displayVessels();
}

/**
 * Purchases one or more copies of a specific vessel with confirmation and sequential processing.
 * Handles single and multi-quantity purchases with affordability checks and rate limiting.
 *
 * Purchase Flow:
 * 1. Calculate total cost (price × quantity)
 * 2. Build confirmation dialog with itemized list
 * 3. Show affordability indicator (green/red)
 * 4. Process purchases sequentially with 1.5s delays
 * 5. Update cash after each successful purchase
 * 6. Handle errors (limit reached, insufficient funds, network errors)
 * 7. Remove from selection list
 * 8. Refresh vessel catalog and counts
 *
 * Error Handling:
 * - 'vessel_limit_reached': Stops purchasing, shows count purchased
 * - 'not_enough_cash': Stops purchasing, shows count purchased
 * - Other errors: Shows error but may continue with remaining
 * - Network errors: Logs and shows feedback
 *
 * Rate Limiting:
 * - 1.5 second delay between purchases to prevent API throttling
 * - No delay after final purchase
 *
 * Side Effects:
 * - Shows confirmation dialog
 * - Makes multiple API calls (one per vessel)
 * - Updates cash after each purchase
 * - Removes from selectedVessels array
 * - Updates selection count badge
 * - Triggers vessel count refresh
 * - Reloads vessel catalog
 * - Shows success/error feedback
 *
 * @async
 * @param {Object} vessel - Vessel object to purchase
 * @param {number} [quantity=1] - Number of copies to purchase
 * @returns {Promise&lt;void>}
 *
 * @example
 * // Buy 3 copies of a container vessel
 * purchaseSingleVessel(vesselObject, 3);
 */
export async function purchaseSingleVessel(vessel, quantity = 1) {
  const bunkerState = getCurrentBunkerState();
  const totalCost = vessel.price * quantity;

  const vesselDetails = [];
  for (let i = 0; i &lt; quantity; i++) {
    vesselDetails.push({
      label: `${i + 1}. ${vessel.name}`,
      value: `$${formatNumber(vessel.price)}`
    });
  }
  vesselDetails.push({
    label: '────────────────────────',
    value: '────────────'
  });
  vesselDetails.push({
    label: 'Total Cost',
    value: `$${formatNumber(totalCost)}`
  });
  vesselDetails.push({
    label: 'Cash Available',
    value: `$${formatNumber(bunkerState.currentCash)}`
  });

  const confirmed = await showConfirmDialog({
    title: `Purchase ${quantity > 1 ? `${quantity} Vessels` : 'Vessel'}`,
    message: quantity > 1 ? 'Purchasing multiple vessels with 1.5s delay between each:' : null,
    details: vesselDetails,
    confirmText: 'Buy',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  let successCount = 0;
  let failCount = 0;

  for (let i = 0; i &lt; quantity; i++) {
    try {
      const data = await apiPurchaseVessel(vessel.id, vessel.name, vessel.antifouling);

      if (data.error) {
        failCount++;
        if (data.error === 'vessel_limit_reached') {
          showSideNotification(`🚢 &lt;strong> Vessel limit reached! Purchased ${successCount} vessel(s), cannot buy more.&lt;/strong>`, 'error', null, true);
          break;
        } else if (data.error === 'not_enough_cash') {
          showSideNotification(`🚢 &lt;strong> Not enough cash! Purchased ${successCount} vessel(s), ran out of money.&lt;/strong>`, 'error', null, true);
          break;
        } else {
          showSideNotification(`🚢 &lt;strong> Error: ${data.error} - Purchased ${successCount} so far`, 'error');
        }
      } else {
        successCount++;
        if (data.user &amp;&amp; data.user.cash !== undefined) {
          updateCurrentCash(data.user.cash);
        }
      }

      if (i &lt; quantity - 1) {
        await new Promise(resolve => setTimeout(resolve, 1500));
      }
    } catch (error) {
      failCount++;
      console.error('Error purchasing vessel:', error);
      showSideNotification(`🚢 &lt;strong> Network error purchasing ${vessel.name}`, 'error', null, true);
    }
  }

  if (successCount > 0 &amp;&amp; failCount === 0) {
    showSideNotification(`🚢 &lt;strong>Purchase Successful!&lt;/strong>&lt;br>&lt;br>Purchased ${successCount}x ${vessel.name}`, 'success');
  }

  if (successCount > 0 &amp;&amp; window.updateVesselCount) {
    await updateVesselCount();
  }

  selectedVessels = selectedVessels.filter(v => v.vessel.id !== vessel.id);
  const totalCount = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);
  const selectedCountEl = document.getElementById('selectedCount');
  const bulkBuyBtn = document.getElementById('bulkBuyBtn');

  if (selectedCountEl) selectedCountEl.textContent = totalCount;
  if (bulkBuyBtn) bulkBuyBtn.style.display = selectedVessels.length > 0 ? 'block' : 'none';

  await loadAcquirableVessels();
}

export async function purchaseBulk() {
  if (selectedVessels.length === 0) return;

  const bunkerState = getCurrentBunkerState();
  const vesselDetails = [];
  let totalCost = 0;
  let itemNumber = 1;

  selectedVessels.forEach(item => {
    for (let i = 0; i &lt; item.quantity; i++) {
      vesselDetails.push({
        label: `${itemNumber}. ${item.vessel.name}`,
        value: `$${formatNumber(item.vessel.price)}`
      });
      totalCost += item.vessel.price;
      itemNumber++;
    }
  });

  vesselDetails.push({
    label: '────────────────────────',
    value: '────────────'
  });
  vesselDetails.push({
    label: 'Total Cost',
    value: `$${formatNumber(totalCost)}`
  });
  vesselDetails.push({
    label: 'Cash Available',
    value: `$${formatNumber(bunkerState.currentCash)}`
  });

  const totalVesselCount = selectedVessels.reduce((sum, item) => sum + item.quantity, 0);

  const confirmed = await showConfirmDialog({
    title: `Bulk Purchase (${totalVesselCount} Vessels)`,
    message: 'Purchasing vessels sequentially with 1.5s delay between each:',
    details: vesselDetails,
    confirmText: 'Buy All',
    cancelText: 'Cancel'
  });

  if (!confirmed) return;

  const bulkBuyBtn = document.getElementById('bulkBuyBtn');
  bulkBuyBtn.disabled = true;
  bulkBuyBtn.textContent = 'Purchasing...';

  let successCount = 0;
  let failCount = 0;

  for (let i = 0; i &lt; selectedVessels.length; i++) {
    const item = selectedVessels[i];

    for (let q = 0; q &lt; item.quantity; q++) {
      try {
        const data = await apiPurchaseVessel(item.vessel.id, item.vessel.name, item.vessel.antifouling);

        if (data.error) {
          failCount++;
          console.error(`Failed to purchase ${item.vessel.name}:`, data.error);

          if (data.error === 'vessel_limit_reached') {
            showSideNotification(`🚢 &lt;strong> Vessel limit reached! Purchased ${successCount} vessel(s), could not buy more.&lt;/strong>`, 'error', null, true);
            i = selectedVessels.length;
            break;
          } else if (data.error === 'not_enough_cash') {
            showSideNotification(`🚢 &lt;strong> Not enough cash! Purchased ${successCount} vessel(s), ran out of money.&lt;/strong>`, 'error', null, true);
            i = selectedVessels.length;
            break;
          } else {
            showSideNotification(`🚢 &lt;strong> Error: ${data.error} - Purchased ${successCount} so far`, 'error');
          }
        } else {
          successCount++;
          if (data.user &amp;&amp; data.user.cash !== undefined) {
            updateCurrentCash(data.user.cash);
          }
        }
      } catch (error) {
        failCount++;
        console.error(`Error purchasing ${item.vessel.name}:`, error);
        showSideNotification(`🚢 &lt;strong> Network error purchasing ${item.vessel.name}`, 'error', null, true);
      }

      await new Promise(resolve => setTimeout(resolve, 1500));
    }
  }

  if (bulkBuyBtn) {
    bulkBuyBtn.disabled = false;
    bulkBuyBtn.textContent = `💰 Bulk Buy (0)`;
    bulkBuyBtn.style.display = 'none';
  }

  selectedVessels = [];
  const selectedCountEl = document.getElementById('selectedCount');
  if (selectedCountEl) selectedCountEl.textContent = '0';

  if (successCount > 0 &amp;&amp; failCount === 0) {
    showSideNotification(`🚢 &lt;strong>Bulk Purchase Successful!&lt;/strong>&lt;br>&lt;br>Purchased ${successCount} vessel(s)`, 'success');
  }

  if (successCount > 0 &amp;&amp; window.updateVesselCount) {
    await updateVesselCount();
  }

  await loadAcquirableVessels();
}

export function setVesselFilter(filter) {
  currentVesselFilter = filter;
  selectedEngineType = null;
}

export function getVesselFilter() {
  return currentVesselFilter;
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
