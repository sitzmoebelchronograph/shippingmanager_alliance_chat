<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/bunker-management.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showFeedback">showFeedback</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showPriceAlert">showPriceAlert</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/bunker-management.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Bunker Management Module - Handles fuel and CO2 quota purchasing, real-time price monitoring,
 * and automated price alerts for the Shipping Manager game. This module tracks commodity prices in 30-minute
 * UTC time slots and triggers browser/desktop notifications when prices fall below user-defined thresholds.
 * Also monitors marketing campaign status and notifies users when campaigns are not fully active.
 *
 * Key Features:
 * - Real-time fuel and CO2 price tracking with 30-minute UTC time slot granularity
 * - Price alert system with browser notifications when thresholds are met
 * - Maximum capacity tracking and purchase cost calculations
 * - Marketing campaign monitoring (3 types: reputation, awareness, green)
 * - Auto-rebuy integration for automated purchasing when conditions are met
 *
 * Price Alert Logic:
 * - Alerts trigger once per price change (prevents spam)
 * - Resets when price goes above threshold (allows re-alert on next drop)
 * - Supports both in-app visual alerts and desktop notifications
 *
 * @module bunker-management
 * @requires utils - Formatting, feedback, and notification functions
 * @requires api - Backend API calls for price data and purchases
 * @requires ui-dialogs - Confirmation dialogs for purchases
 */

import { formatNumber, showFeedback, showPriceAlert, showNotification } from './utils.js';
import { fetchBunkerPrices, purchaseFuel as apiPurchaseFuel, purchaseCO2 as apiPurchaseCO2, fetchCampaigns } from './api.js';
import { showConfirmDialog } from './ui-dialogs.js';

/**
 * Maximum fuel storage capacity in tons.
 * This is a hardcoded game constant representing the player's fuel tank size.
 * @type {number}
 */
let maxFuel = 5750;

/**
 * Maximum CO2 quota storage capacity in tons.
 * This is a hardcoded game constant representing the player's CO2 allowance capacity.
 * @type {number}
 */
let maxCO2 = 55000;

/**
 * Current fuel inventory in tons.
 * Updated from API responses and decremented when vessels depart.
 * @type {number}
 */
let currentFuel = 0;

/**
 * Current CO2 quota inventory in tons.
 * Can be negative if player exceeded their quota. Updated from API responses.
 * @type {number}
 */
let currentCO2 = 0;

/**
 * Current cash balance in dollars.
 * Updated from API responses and used for purchase affordability checks.
 * @type {number}
 */
let currentCash = 0;

/**
 * Current fuel price per ton in dollars.
 * Retrieved from API based on current UTC time slot (30-minute intervals).
 * @type {number}
 */
let fuelPrice = 0;

/**
 * Current CO2 quota price per ton in dollars.
 * Retrieved from API based on current UTC time slot (30-minute intervals).
 * @type {number}
 */
let co2Price = 0;

/**
 * Last fuel price that triggered an alert.
 * Used to prevent duplicate alerts for the same price. Resets when price goes above threshold.
 * @type {number|null}
 */
let lastFuelAlertPrice = null;

/**
 * Last CO2 price that triggered an alert.
 * Used to prevent duplicate alerts for the same price. Resets when price goes above threshold.
 * @type {number|null}
 */
let lastCO2AlertPrice = null;

/**
 * Last known count of active marketing campaigns.
 * Used to detect changes in campaign status and trigger alerts accordingly.
 * @type {number|null}
 */
let lastCampaignsCount = null;

/**
 * Updates bunker (fuel/CO2) status display and triggers price alerts if thresholds are met.
 * This is the core function for monitoring commodity prices and inventory levels.
 *
 * Price Monitoring Strategy:
 * - Prices update every 30 minutes based on UTC time slots (e.g., 14:00, 14:30, 15:00)
 * - Compares current prices against user-configured thresholds
 * - Triggers visual and desktop notifications when prices drop below thresholds
 * - Only alerts once per price drop to prevent notification spam
 *
 * Side Effects:
 * - Updates DOM elements for fuel, CO2, cash, and price displays
 * - Triggers browser notifications (if permission granted)
 * - Shows in-app price alert overlays
 * - Calls auto-rebuy checks via global callback (if AutoPilot enabled)
 * - Updates button tooltips with purchase calculations
 *
 * @async
 * @param {Object} settings - User settings object containing price thresholds
 * @param {number} settings.fuelThreshold - Fuel price threshold in $/ton for alerts
 * @param {number} settings.co2Threshold - CO2 price threshold in $/ton for alerts
 * @returns {Promise&lt;void>}
 * @throws {Error} Silently catches and logs errors to console
 *
 * @example
 * // Called automatically every 30-35 seconds by main app
 * updateBunkerStatus({ fuelThreshold: 400, co2Threshold: 7 });
 */
export async function updateBunkerStatus(settings) {
  try {
    // Silent update - no user feedback for routine updates
    const data = await fetchBunkerPrices();

    currentFuel = (data.user.fuel || 0) / 1000;
    currentCO2 = (data.user.co2 || 0) / 1000;
    currentCash = data.user.cash || 0;

    const now = new Date();
    const utcHours = now.getUTCHours();
    const utcMinutes = now.getUTCMinutes();
    const currentTimeSlot = `${String(utcHours).padStart(2, '0')}:${utcMinutes &lt; 30 ? '00' : '30'}`;

    const currentPriceData = data.data.prices.find(p => p.time === currentTimeSlot);

    if (currentPriceData) {
      fuelPrice = currentPriceData.fuel_price;
      co2Price = currentPriceData.co2_price;
    }

    const fuelDisplay = document.getElementById('fuelDisplay');
    const co2Display = document.getElementById('co2Display');
    const cashDisplay = document.getElementById('cashDisplay');
    const fuelPriceDisplay = document.getElementById('fuelPriceDisplay');
    const co2PriceDisplay = document.getElementById('co2PriceDisplay');

    fuelDisplay.innerHTML = `${formatNumber(Math.floor(currentFuel))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxFuel))} &lt;b>t&lt;/b>`;

    if (currentCO2 &lt; 0) {
      co2Display.innerHTML = `-${formatNumber(Math.floor(Math.abs(currentCO2)))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxCO2))} &lt;b>t&lt;/b>`;
    } else {
      co2Display.innerHTML = `${formatNumber(Math.floor(currentCO2))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxCO2))} &lt;b>t&lt;/b>`;
    }

    cashDisplay.textContent = `$${formatNumber(currentCash)}`;

    if (fuelPrice &lt;= settings.fuelThreshold) {
      fuelPriceDisplay.textContent = `$${formatNumber(fuelPrice)}/t`;
      fuelPriceDisplay.style.color = '#4ade80';
      fuelPriceDisplay.style.fontWeight = '700';
    } else {
      fuelPriceDisplay.textContent = `$${formatNumber(fuelPrice)}/t`;
      fuelPriceDisplay.style.color = '#9ca3af';
      fuelPriceDisplay.style.fontWeight = '500';
    }

    if (co2Price &lt;= settings.co2Threshold) {
      co2PriceDisplay.textContent = `$${formatNumber(co2Price)}/t`;
      co2PriceDisplay.style.color = '#4ade80';
      co2PriceDisplay.style.fontWeight = '700';
    } else {
      co2PriceDisplay.textContent = `$${formatNumber(co2Price)}/t`;
      co2PriceDisplay.style.color = '#9ca3af';
      co2PriceDisplay.style.fontWeight = '500';
    }

    const fuelNeeded = Math.max(0, maxFuel - currentFuel);
    const co2Needed = Math.max(0, maxCO2 - currentCO2);
    const fuelCost = fuelNeeded * fuelPrice;
    const co2Cost = co2Needed * co2Price;

    document.getElementById('fuelBtn').title = `Buy ${formatNumber(fuelNeeded)}t fuel for $${formatNumber(fuelCost)} (Price: $${fuelPrice}/t)`;
    document.getElementById('co2Btn').title = `Buy ${formatNumber(co2Needed)}t CO2 for $${formatNumber(co2Cost)} (Price: $${co2Price}/t)`;

    const hasPermission = Notification.permission === "granted";

    if (fuelPrice &lt;= settings.fuelThreshold &amp;&amp; lastFuelAlertPrice !== fuelPrice) {
      lastFuelAlertPrice = fuelPrice;

      if (hasPermission) {
        await showNotification('â›½ Fuel Price Alert!', {
          body: `New price: $${fuelPrice}/t`,
          icon: "data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>&lt;text y='50%' x='50%' text-anchor='middle' font-size='80'>â›½&lt;/text>&lt;/svg>",
          tag: 'fuel-alert',
          silent: false
        });
      }

      showPriceAlert(`â›½ Fuel Price Alert!&lt;br>&lt;br>Current price: &lt;strong>$${fuelPrice}/ton&lt;/strong>&lt;br>Your threshold: $${settings.fuelThreshold}/ton`, 'warning');
    }

    if (co2Price &lt;= settings.co2Threshold &amp;&amp; lastCO2AlertPrice !== co2Price) {
      lastCO2AlertPrice = co2Price;

      if (hasPermission) {
        await showNotification('ðŸ’¨ CO2 Price Alert!', {
          body: `New price: $${co2Price}/t`,
          icon: "data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>&lt;text y='50%' x='50%' text-anchor='middle' font-size='80'>ðŸ’¨&lt;/text>&lt;/svg>",
          tag: 'co2-alert',
          silent: false
        });
      }

      showPriceAlert(`ðŸ’¨ CO2 Price Alert!&lt;br>&lt;br>Current price: &lt;strong>$${co2Price}/ton&lt;/strong>&lt;br>Your threshold: $${settings.co2Threshold}/ton`, 'warning');
    }

    if (fuelPrice > settings.fuelThreshold) {
      lastFuelAlertPrice = null;
    }
    if (co2Price > settings.co2Threshold) {
      lastCO2AlertPrice = null;
    }

    // Trigger auto-rebuy checks (prices already updated above)
    if (window.triggerAutoRebuyChecks) {
      window.triggerAutoRebuyChecks(settings);
    }

  } catch (error) {
    console.error('Error updating bunker status:', error);
  }
}

/**
 * Updates marketing campaigns status display and triggers alerts for inactive campaigns.
 * Monitors three required campaign types: reputation, awareness, and green.
 *
 * Campaign Monitoring Logic:
 * - Checks if all 3 required campaign types are active
 * - Updates badge display showing active count (hidden if all 3 active)
 * - On first load: alerts if not all campaigns active
 * - On subsequent checks: alerts on any count change
 * - Shows success feedback when reaching 3/3 active
 *
 * Side Effects:
 * - Updates DOM badge display and button tooltip
 * - Triggers desktop notifications for campaign status changes
 * - Shows in-app price alerts for campaign warnings
 * - Updates lastCampaignsCount state for change detection
 *
 * @async
 * @returns {Promise&lt;void>}
 * @throws {Error} Silently catches and logs errors to console
 *
 * @example
 * // Called automatically every 30-35 seconds alongside bunker updates
 * updateCampaignsStatus();
 */
export async function updateCampaignsStatus() {
  try {
    const data = await fetchCampaigns();

    const activeCampaigns = data.data.active_campaigns || [];
    const activeTypes = new Set(activeCampaigns.map(c => c.option_name));

    const requiredTypes = ['reputation', 'awareness', 'green'];
    const activeCount = requiredTypes.filter(type => activeTypes.has(type)).length;

    const badge = document.getElementById('campaignsCount');
    const button = document.getElementById('campaignsBtn');

    if (activeCount === 3) {
      badge.style.display = 'none';
    } else {
      badge.textContent = activeCount;
      badge.style.display = 'block';
      badge.style.background = '#ef4444';
    }

    const statusList = requiredTypes.map(type => {
      const isActive = activeTypes.has(type);
      const icon = isActive ? 'âœ“' : 'âœ—';
      const name = type.charAt(0).toUpperCase() + type.slice(1);
      return `${icon} ${name}`;
    }).join('\n');

    button.title = `Marketing Campaigns (${activeCount}/3 active)\n${statusList}`;

    if (lastCampaignsCount === null) {
      if (activeCount !== 3) {
        showPriceAlert(`âš ï¸ Only ${activeCount}/3 marketing campaigns are active!`, 'warning');

        if (Notification.permission === 'granted') {
          await showNotification('ðŸ“Š Marketing Campaigns Alert!', {
            body: `Only ${activeCount}/3 campaigns active`,
            icon: "data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>&lt;text y='50%' x='50%' text-anchor='middle' font-size='80'>ðŸ“Š&lt;/text>&lt;/svg>",
            tag: 'campaigns-alert',
            silent: false
          });
        }
      }
    } else if (lastCampaignsCount !== activeCount) {
      if (activeCount === 3) {
        showFeedback('âœ… All 3 marketing campaigns are now active!', 'success');
      } else {
        showPriceAlert(`âš ï¸ Marketing campaigns changed: ${activeCount}/3 active`, 'warning');

        if (Notification.permission === 'granted') {
          await showNotification('ðŸ“Š Marketing Campaigns Alert!', {
            body: `Only ${activeCount}/3 campaigns active`,
            icon: "data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>&lt;text y='50%' x='50%' text-anchor='middle' font-size='80'>ðŸ“Š&lt;/text>&lt;/svg>",
            tag: 'campaigns-alert',
            silent: false
          });
        }
      }
    }

    lastCampaignsCount = activeCount;

  } catch (error) {
    console.error('Error updating campaigns status:', error);
  }
}

/**
 * Initiates purchase of fuel to fill the tank to maximum capacity.
 * Calculates amount needed, shows confirmation dialog with cost breakdown, and processes purchase.
 *
 * Purchase Flow:
 * 1. Calculate fuel needed (maxFuel - currentFuel)
 * 2. Check if already full (early exit if needed = 0)
 * 3. Calculate total cost (needed Ã— current price)
 * 4. Show confirmation dialog with purchase details
 * 5. Process API purchase if confirmed
 * 6. Trigger bunker status refresh after successful purchase
 *
 * Side Effects:
 * - Shows confirmation dialog (blocks until user responds)
 * - Makes API call to purchase fuel
 * - Updates UI via debounced bunker status refresh
 * - Shows success/error feedback messages
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // User clicks "Buy Fuel" button
 * buyMaxFuel();
 * // Shows dialog: "Purchase 2,500t fuel for $1,000,000?"
 */
export async function buyMaxFuel() {
  const fuelNeeded = Math.max(0, maxFuel - currentFuel);

  if (fuelNeeded === 0) {
    showFeedback('Fuel tank is already full!', 'error');
    return;
  }

  const totalCost = fuelNeeded * fuelPrice;

  const confirmed = await showConfirmDialog({
    title: 'â›½ Purchase Fuel',
    message: 'Do you want to purchase fuel to fill your tank?',
    confirmText: 'Buy Fuel',
    details: [
      { label: 'Amount needed', value: `${formatNumber(fuelNeeded)}t` },
      { label: 'Price per ton', value: `$${formatNumber(fuelPrice)}/t` },
      { label: 'Total Cost', value: `$${formatNumber(totalCost)}` },
      { label: 'Available Cash', value: `$${formatNumber(currentCash)}` }
    ]
  });

  if (!confirmed) {
    return;
  }

  try {
    const data = await apiPurchaseFuel(fuelNeeded);

    if (data.error) {
      showFeedback(`Error: ${data.error}`, 'error');
    } else {
      showFeedback(`Purchased ${formatNumber(fuelNeeded)}t fuel for $${formatNumber(totalCost)}!`, 'success');
      if (window.debouncedUpdateBunkerStatus) {
        window.debouncedUpdateBunkerStatus(500);
      }
    }
  } catch (error) {
    showFeedback(`Error: ${error.message}`, 'error');
  }
}

/**
 * Initiates purchase of CO2 quota to fill storage to maximum capacity.
 * Calculates amount needed, shows confirmation dialog with cost breakdown, and processes purchase.
 *
 * Purchase Flow:
 * 1. Calculate CO2 needed (maxCO2 - currentCO2)
 * 2. Check if already full (early exit if needed = 0)
 * 3. Calculate total cost (needed Ã— current price)
 * 4. Show confirmation dialog with purchase details
 * 5. Process API purchase if confirmed
 * 6. Trigger bunker status refresh after successful purchase
 *
 * Side Effects:
 * - Shows confirmation dialog (blocks until user responds)
 * - Makes API call to purchase CO2 quota
 * - Updates UI via debounced bunker status refresh
 * - Shows success/error feedback messages
 *
 * @async
 * @returns {Promise&lt;void>}
 *
 * @example
 * // User clicks "Buy CO2" button
 * buyMaxCO2();
 * // Shows dialog: "Purchase 25,000t CO2 for $175,000?"
 */
export async function buyMaxCO2() {
  const co2Needed = Math.max(0, maxCO2 - currentCO2);

  if (co2Needed === 0) {
    showFeedback('CO2 storage is already full!', 'error');
    return;
  }

  const totalCost = co2Needed * co2Price;

  const confirmed = await showConfirmDialog({
    title: 'ðŸ’¨ Purchase CO2 Quota',
    message: 'Do you want to purchase CO2 quota to fill your storage?',
    confirmText: 'Buy CO2',
    details: [
      { label: 'Amount needed', value: `${formatNumber(co2Needed)}t` },
      { label: 'Price per ton', value: `$${formatNumber(co2Price)}/t` },
      { label: 'Total Cost', value: `$${formatNumber(totalCost)}` },
      { label: 'Available Cash', value: `$${formatNumber(currentCash)}` }
    ]
  });

  if (!confirmed) {
    return;
  }

  try {
    const data = await apiPurchaseCO2(co2Needed);

    if (data.error) {
      showFeedback(`Error: ${data.error}`, 'error');
    } else {
      showFeedback(`Purchased ${formatNumber(co2Needed)}t CO2 for $${formatNumber(totalCost)}!`, 'success');
      if (window.debouncedUpdateBunkerStatus) {
        window.debouncedUpdateBunkerStatus(500);
      }
    }
  } catch (error) {
    showFeedback(`Error: ${error.message}`, 'error');
  }
}

/**
 * Returns a snapshot of the current bunker inventory and pricing state.
 * Used by other modules to access bunker data without direct variable access.
 *
 * This function provides read-only access to critical bunker management data,
 * allowing other modules (like vessel-management) to check affordability and
 * inventory levels before performing operations.
 *
 * @returns {Object} Current bunker state object
 * @returns {number} return.currentFuel - Current fuel inventory in tons
 * @returns {number} return.currentCO2 - Current CO2 quota in tons (can be negative)
 * @returns {number} return.currentCash - Current cash balance in dollars
 * @returns {number} return.fuelPrice - Current fuel price per ton in dollars
 * @returns {number} return.co2Price - Current CO2 price per ton in dollars
 * @returns {number} return.maxFuel - Maximum fuel capacity in tons
 * @returns {number} return.maxCO2 - Maximum CO2 capacity in tons
 *
 * @example
 * const bunkerState = getCurrentBunkerState();
 * if (bunkerState.currentCash >= purchaseCost) {
 *   // Proceed with purchase
 * }
 */
export function getCurrentBunkerState() {
  return {
    currentFuel,
    currentCO2,
    currentCash,
    fuelPrice,
    co2Price,
    maxFuel,
    maxCO2
  };
}

/**
 * Updates the current cash balance and refreshes the UI display.
 * Used by other modules to update cash after purchases or vessel operations.
 *
 * This function provides a centralized way to update cash display without
 * directly accessing module-level variables, maintaining encapsulation.
 *
 * Side Effects:
 * - Updates module-level currentCash variable
 * - Updates DOM element with formatted cash value
 *
 * @param {number} newCash - New cash balance in dollars
 *
 * @example
 * // After purchasing a vessel for $5,000,000
 * const currentState = getCurrentBunkerState();
 * updateCurrentCash(currentState.currentCash - 5000000);
 */
export function updateCurrentCash(newCash) {
  currentCash = newCash;
  document.getElementById('cashDisplay').textContent = `$${formatNumber(currentCash)}`;
}

/**
 * Updates the current fuel inventory and refreshes the UI display.
 * Used by other modules to update fuel after vessel departures or refueling.
 *
 * Side Effects:
 * - Updates module-level currentFuel variable
 * - Updates DOM element with formatted fuel value showing current/max
 *
 * @param {number} newFuel - New fuel inventory in tons
 *
 * @example
 * // After vessels depart and use 150 tons of fuel
 * const currentState = getCurrentBunkerState();
 * updateCurrentFuel(currentState.currentFuel - 150);
 */
export function updateCurrentFuel(newFuel) {
  currentFuel = newFuel;
  document.getElementById('fuelDisplay').innerHTML = `${formatNumber(Math.floor(currentFuel))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxFuel))} &lt;b>t&lt;/b>`;
}

/**
 * Updates the current CO2 quota inventory and refreshes the UI display.
 * Handles negative values (quota overage) with special formatting.
 *
 * Side Effects:
 * - Updates module-level currentCO2 variable
 * - Updates DOM element with formatted CO2 value showing current/max
 * - Displays negative sign prefix when quota is exceeded
 *
 * @param {number} newCO2 - New CO2 quota in tons (can be negative)
 *
 * @example
 * // After vessels depart and emit 300 tons of CO2
 * const currentState = getCurrentBunkerState();
 * updateCurrentCO2(currentState.currentCO2 - 300);
 * // Display might show: "-50 t / 55,000 t" if player exceeded quota
 */
export function updateCurrentCO2(newCO2) {
  currentCO2 = newCO2;
  if (currentCO2 &lt; 0) {
    document.getElementById('co2Display').innerHTML = `-${formatNumber(Math.floor(Math.abs(currentCO2)))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxCO2))} &lt;b>t&lt;/b>`;
  } else {
    document.getElementById('co2Display').innerHTML = `${formatNumber(Math.floor(currentCO2))} &lt;b>t&lt;/b> &lt;b>/&lt;/b> ${formatNumber(Math.floor(maxCO2))} &lt;b>t&lt;/b>`;
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
