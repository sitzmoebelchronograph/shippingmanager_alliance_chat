<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>public/js/modules/api.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showFeedback">showFeedback</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showPriceAlert">showPriceAlert</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">public/js/modules/api.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview API module for all client-server communication.
 * Handles all HTTP requests to the backend API endpoints including chat,
 * vessels, bunker management, messenger, campaigns, and user data.
 *
 * All functions implement proper error handling and return promises.
 * Company names are cached to reduce API calls.
 *
 * @module api
 */

/**
 * Cache for storing user company names to reduce API calls.
 * Key: userId (number), Value: companyName (string)
 * @type {Map&lt;number, string>}
 */
const userCache = new Map();

/**
 * Fetches company name for a user with caching.
 * Returns cached value if available, otherwise fetches from API.
 * Falls back to "User {id}" if fetch fails.
 *
 * @param {number|string} userId - User ID to fetch company name for
 * @returns {Promise&lt;string>} Company name or fallback string
 * @example
 * const name = await getCompanyNameCached(123);
 * // => "Acme Shipping Co."
 */
export async function getCompanyNameCached(userId) {
  const userIdInt = parseInt(userId);
  if (userCache.has(userIdInt)) {
    return userCache.get(userIdInt);
  }

  try {
    const response = await fetch('/api/company-name', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userIdInt })
    });

    if (!response.ok) throw new Error('Failed to get company name');
    const data = await response.json();
    const name = data.company_name;
    userCache.set(userIdInt, name);
    return name;
  } catch {
    return `User ${userIdInt}`;
  }
}

/**
 * Fetches the list of all alliance members.
 * Returns empty array if request fails.
 *
 * @returns {Promise&lt;Array&lt;Object>>} Array of alliance member objects
 * @property {number} user_id - Member's user ID
 * @property {string} company_name - Member's company name
 */
export async function fetchAllianceMembers() {
  try {
    const response = await fetch('/api/alliance-members');
    if (!response.ok) throw new Error('Failed to load alliance members');
    return await response.json();
  } catch (error) {
    console.error('Error loading alliance members:', error);
    return [];
  }
}

/**
 * Fetches the alliance chat feed including both chat messages and system feed events.
 *
 * @returns {Promise&lt;Object>} Chat data object
 * @property {Array&lt;Object>} feed - Array of chat/feed events
 * @property {number} own_user_id - Current user's ID
 * @property {string} own_company_name - Current user's company name
 * @throws {Error} If fetch fails
 */
export async function fetchChat() {
  try {
    const response = await fetch('/api/chat');
    if (!response.ok) throw new Error('Failed to load chat feed');
    return await response.json();
  } catch (error) {
    console.error('Error loading messages:', error);
    throw error;
  }
}

/**
 * Sends a message to the alliance chat.
 * Message must be valid according to game rules (length, content).
 *
 * @param {string} message - Message text to send
 * @returns {Promise&lt;Object>} Response data from server
 * @property {boolean} success - Whether message was sent successfully
 * @throws {Error} If message sending fails or validation fails
 */
export async function sendChatMessage(message) {
  try {
    const response = await fetch('/api/send-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: message })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Fetches all vessels owned by the current user.
 * Includes vessels in harbor, at sea, and pending delivery.
 *
 * @returns {Promise&lt;Object>} Vessel data object
 * @property {Array&lt;Object>} vessels - Array of vessel objects
 * @property {Object} vessels[].vessel_id - Unique vessel ID
 * @property {string} vessels[].name - Vessel name
 * @property {string} vessels[].status - Status (harbor/at_sea/pending)
 * @property {number} vessels[].wear - Wear percentage (0-100)
 * @throws {Error} If fetch fails
 */
export async function fetchVessels() {
  try {
    const response = await fetch('/api/vessel/get-vessels');
    if (!response.ok) throw new Error('Failed to get vessels');
    return await response.json();
  } catch (error) {
    console.error('Error fetching vessels:', error);
    throw error;
  }
}

/**
 * Fetches current user settings and account information.
 *
 * @returns {Promise&lt;Object>} User settings object
 * @property {number} user_id - User ID
 * @property {string} company_name - Company name
 * @property {number} cash - Current cash balance
 * @throws {Error} If fetch fails
 */
export async function fetchUserSettings() {
  try {
    const response = await fetch('/api/user/get-settings');
    if (!response.ok) throw new Error('Failed to get user settings');
    return await response.json();
  } catch (error) {
    console.error('Error fetching user settings:', error);
    throw error;
  }
}

/**
 * Fetches current bunker fuel and CO2 prices.
 * Prices fluctuate based on game economy and are updated every 30-35 seconds.
 *
 * @returns {Promise&lt;Object>} Bunker prices and status
 * @property {number} fuel_price - Current fuel price per ton
 * @property {number} co2_price - Current CO2 price per ton
 * @property {number} current_fuel - Current fuel in bunker
 * @property {number} max_fuel - Maximum fuel capacity
 * @property {number} current_co2 - Current CO2 in bunker
 * @property {number} max_co2 - Maximum CO2 capacity
 * @property {number} current_cash - Current cash balance
 * @throws {Error} If fetch fails
 */
export async function fetchBunkerPrices() {
  try {
    const response = await fetch('/api/bunker/get-prices');
    if (!response.ok) throw new Error('Failed to get bunker prices');
    return await response.json();
  } catch (error) {
    console.error('Error fetching bunker prices:', error);
    throw error;
  }
}

/**
 * Purchases fuel for the bunker.
 * Amount is multiplied by 1000 before sending (API expects millitons).
 *
 * @param {number} amount - Amount of fuel to purchase in tons
 * @returns {Promise&lt;Object>} Purchase result
 * @property {boolean} success - Whether purchase was successful
 * @property {number} new_balance - New cash balance after purchase
 * @throws {Error} If purchase fails (insufficient funds, invalid amount)
 */
export async function purchaseFuel(amount) {
  try {
    const response = await fetch('/api/bunker/purchase-fuel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: Math.round(amount * 1000) })
    });
    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Purchases CO2 credits for the bunker.
 * Amount is multiplied by 1000 before sending (API expects millitons).
 *
 * @param {number} amount - Amount of CO2 to purchase in tons
 * @returns {Promise&lt;Object>} Purchase result
 * @property {boolean} success - Whether purchase was successful
 * @property {number} new_balance - New cash balance after purchase
 * @throws {Error} If purchase fails (insufficient funds, invalid amount)
 */
export async function purchaseCO2(amount) {
  try {
    const response = await fetch('/api/bunker/purchase-co2', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount: Math.round(amount * 1000) })
    });
    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Departs all vessels currently in harbor that have available routes and fuel.
 * Part of the auto-depart feature.
 *
 * @returns {Promise&lt;Object>} Departure result
 * @property {number} departed - Number of vessels departed
 * @property {Array&lt;string>} errors - Array of error messages for vessels that couldn't depart
 * @throws {Error} If request fails
 */
export async function departAllVessels() {
  try {
    const response = await fetch('/api/route/depart-all', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) {
      throw new Error('Failed to depart vessels');
    }

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Fetches the user's contact list.
 * Returns both regular contacts and alliance contacts.
 *
 * @returns {Promise&lt;Object>} Contact data
 * @property {Array&lt;Object>} contacts - Regular contacts
 * @property {Array&lt;Object>} alliance_contacts - Alliance member contacts
 * @throws {Error} If fetch fails
 */
export async function fetchContacts() {
  try {
    const response = await fetch('/api/contact/get-contacts');
    if (!response.ok) throw new Error('Failed to get contacts');
    return await response.json();
  } catch (error) {
    console.error('Error loading contact list:', error);
    throw error;
  }
}

/**
 * Fetches all messenger chats for the current user.
 * Includes both regular chats and system messages.
 *
 * @returns {Promise&lt;Object>} Messenger data
 * @property {Array&lt;Object>} chats - Array of chat conversations
 * @property {number} own_user_id - Current user's ID
 * @property {string} own_company_name - Current user's company name
 * @throws {Error} If fetch fails
 */
export async function fetchMessengerChats() {
  try {
    const response = await fetch('/api/messenger/get-chats');
    if (!response.ok) throw new Error('Failed to get chats');
    return await response.json();
  } catch (error) {
    console.error('Error getting chats:', error);
    throw error;
  }
}

/**
 * Fetches all messages for a specific chat conversation.
 *
 * @param {number} chatId - Chat ID to fetch messages for
 * @returns {Promise&lt;Object>} Messages data
 * @property {Array&lt;Object>} messages - Array of message objects
 * @throws {Error} If fetch fails
 */
export async function fetchMessengerMessages(chatId) {
  try {
    const response = await fetch('/api/messenger/get-messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId })
    });

    if (!response.ok) throw new Error('Failed to load messages');
    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Sends a private message to another user.
 * Creates a new chat or continues existing conversation.
 *
 * @param {number} targetUserId - Recipient's user ID
 * @param {string} subject - Message subject (only for new chats)
 * @param {string} message - Message content
 * @returns {Promise&lt;Object>} Send result
 * @property {boolean} success - Whether message was sent
 * @throws {Error} If send fails or validation fails
 */
export async function sendPrivateMessage(targetUserId, subject, message) {
  try {
    const response = await fetch('/api/messenger/send-private', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target_user_id: targetUserId,
        subject: subject,
        message: message
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Deletes a chat conversation or system message.
 * System messages and regular chats are handled differently by the API.
 *
 * @param {number} chatId - Chat ID to delete
 * @param {boolean} [isSystemChat=false] - Whether this is a system message
 * @returns {Promise&lt;Object>} Deletion result
 * @property {boolean} success - Whether deletion was successful
 * @throws {Error} If deletion fails
 */
export async function deleteChat(chatId, isSystemChat = false) {
  try {
    const response = await fetch('/api/messenger/delete-chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_ids: isSystemChat ? '[]' : `[${chatId}]`,
        system_message_ids: isSystemChat ? `[${chatId}]` : '[]'
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to delete chat');
    }

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Fetches available marketing campaigns and currently active campaigns.
 * Campaigns provide temporary bonuses (reputation, awareness, green).
 *
 * @returns {Promise&lt;Object>} Campaign data
 * @property {Object} data - Campaign data
 * @property {Array&lt;Object>} data.marketing_campaigns - All available campaigns
 * @property {Array&lt;Object>} data.active_campaigns - Currently active campaigns
 * @property {Object} user - User data including reputation
 * @throws {Error} If fetch fails
 */
export async function fetchCampaigns() {
  try {
    const response = await fetch('/api/marketing/get-campaigns');
    if (!response.ok) throw new Error('Failed to fetch campaigns');
    return await response.json();
  } catch (error) {
    console.error('Error fetching campaigns:', error);
    throw error;
  }
}

/**
 * Activates a marketing campaign by purchasing it.
 * Only 3 campaigns can be active simultaneously (one of each type).
 *
 * @param {number} campaignId - Campaign ID to activate
 * @returns {Promise&lt;Object>} Activation result
 * @property {boolean} success - Whether activation was successful
 * @property {number} new_balance - New cash balance after purchase
 * @throws {Error} If activation fails (insufficient funds, already active)
 */
export async function activateCampaign(campaignId) {
  try {
    const response = await fetch('/api/marketing/activate-campaign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ campaign_id: campaignId })
    });

    if (!response.ok) throw new Error('Failed to activate campaign');
    return await response.json();
  } catch (error) {
    console.error('Error activating campaign:', error);
    throw error;
  }
}

/**
 * Fetches all vessels available for purchase in the market.
 * Includes vessel specifications, prices, and engine types.
 *
 * @returns {Promise&lt;Object>} Available vessels data
 * @property {Array&lt;Object>} vessels - Array of purchasable vessels
 * @throws {Error} If fetch fails
 */
export async function fetchAcquirableVessels() {
  try {
    const response = await fetch('/api/vessel/get-all-acquirable');
    if (!response.ok) throw new Error('Failed to load vessels');
    return await response.json();
  } catch (error) {
    console.error('Error loading vessels:', error);
    throw error;
  }
}

/**
 * Purchases a vessel from the market.
 * User provides name and antifouling choice during purchase.
 *
 * @param {number} vesselId - Vessel ID to purchase
 * @param {string} name - Custom name for the vessel
 * @param {string} antifouling - Antifouling model choice
 * @returns {Promise&lt;Object>} Purchase result
 * @property {boolean} success - Whether purchase was successful
 * @property {number} new_balance - New cash balance
 * @throws {Error} If purchase fails (insufficient funds, invalid name)
 */
export async function purchaseVessel(vesselId, name, antifouling) {
  try {
    const response = await fetch('/api/vessel/purchase-vessel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        vessel_id: vesselId,
        name: name,
        antifouling_model: antifouling
      })
    });

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Gets the total maintenance cost for specified vessels.
 * Used before performing bulk repair to show cost to user.
 *
 * @param {Array&lt;number>} vesselIds - Array of vessel IDs to check cost for
 * @returns {Promise&lt;Object>} Cost data
 * @property {number} total_cost - Total repair cost
 * @throws {Error} If request fails
 */
export async function getMaintenanceCost(vesselIds) {
  try {
    const response = await fetch('/api/maintenance/get', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vessel_ids: JSON.stringify(vesselIds) })
    });

    if (!response.ok) throw new Error('Failed to get repair cost');
    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Performs wear maintenance (repair) on multiple vessels at once.
 * Used by auto-repair feature and manual bulk repair button.
 *
 * @param {Array&lt;number>} vesselIds - Array of vessel IDs to repair
 * @returns {Promise&lt;Object>} Repair result
 * @property {number} repaired - Number of vessels repaired
 * @property {number} cost - Total cost of repairs
 * @throws {Error} If repair fails (insufficient funds)
 */
export async function doWearMaintenanceBulk(vesselIds) {
  try {
    const response = await fetch('/api/maintenance/do-wear-maintenance-bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ vessel_ids: JSON.stringify(vesselIds) })
    });

    if (!response.ok) throw new Error('Failed to repair vessels');
    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Departs a single vessel on its assigned route.
 * Used by intelligent auto-depart to send only profitable vessels.
 *
 * @param {number} vesselId - Vessel ID to depart
 * @param {number} speed - Speed to travel at (usually % of max_speed)
 * @param {number} [guards=0] - Number of guards (0 or 10 based on hijacking_risk)
 * @returns {Promise&lt;Object>} Departure result
 * @property {boolean} success - Whether vessel was departed successfully
 * @throws {Error} If departure fails (no route, insufficient fuel)
 */
export async function departVessel(vesselId, speed, guards = 0) {
  try {
    const response = await fetch('/api/route/depart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_vessel_id: vesselId,
        speed: speed,
        guards: guards,
        history: 0
      })
    });

    if (!response.ok) {
      throw new Error('Failed to depart vessel');
    }

    return await response.json();
  } catch (error) {
    throw error;
  }
}

/**
 * Fetches demand and consumed data for all assigned ports.
 * Used by intelligent auto-depart to calculate remaining port capacity.
 *
 * @returns {Promise&lt;Array&lt;Object>>} Array of port objects with demand/consumed data
 * @property {string} code - Port code (e.g., "BOS")
 * @property {Object} demand - Port demand for container and tanker cargo
 * @property {Object} consumed - Amount already delivered to port
 * @throws {Error} If fetch fails
 */
export async function fetchAssignedPorts() {
  try {
    const response = await fetch('/api/port/get-assigned-ports');
    if (!response.ok) throw new Error('Failed to fetch assigned ports');
    const data = await response.json();
    return data.data?.ports || [];
  } catch (error) {
    console.error('Error fetching assigned ports:', error);
    throw error;
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
