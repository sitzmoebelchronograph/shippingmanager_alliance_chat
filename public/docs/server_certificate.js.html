<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>server/certificate.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Dark theme matching app style - carefully scoped to not break layout */
        html, body {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            overflow-x: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Custom scrollbar styling for all browsers */
        * {
            scrollbar-width: thin !important;
            scrollbar-color: #404040 #1a1a1a !important;
        }

        /* Webkit browsers (Chrome, Safari, Edge) */
        *::-webkit-scrollbar {
            width: 6px !important;
            height: 6px !important;
        }

        *::-webkit-scrollbar-track {
            background: #1a1a1a !important;
        }

        *::-webkit-scrollbar-thumb {
            background-color: #404040 !important;
            border-radius: 3px !important;
        }

        *::-webkit-scrollbar-thumb:hover {
            background-color: #505050 !important;
        }

        /* Navigation sidebar - remove padding and white borders */
        nav {
            background-color: #242424 !important;
            border-right: 1px solid #404040 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow-x: hidden !important;
        }
        nav h2, nav h3 {
            color: #e0e0e0 !important;
            border-bottom: 1px solid #404040 !important;
            padding: 10px 15px !important;
            margin: 0 !important;
            background-color: #242424 !important;
            font-size: 14px !important;
            font-weight: 600 !important;
        }
        nav h3 {
            font-size: 13px !important;
        }
        nav ul {
            padding: 0 !important;
            margin: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li {
            list-style: none !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #242424 !important;
        }
        nav ul li a {
            color: #c9d1d9 !important;
            display: block !important;
            padding: 8px 15px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            background-color: #242424 !important;
            margin: 0 !important;
            border: none !important;
            font-size: 14px !important;
        }
        nav ul li a:hover {
            color: #60a5fa !important;
            background-color: rgba(96, 165, 250, 0.1) !important;
        }
        /* Module links (direct children of nav > ul > li) */
        nav > ul > li > a {
            color: #60a5fa !important;
            font-weight: 600 !important;
            padding: 10px 15px !important;
            font-size: 14px !important;
            border-left: 3px solid #60a5fa !important;
            padding-left: 12px !important;
        }
        nav > ul > li > a:hover {
            background-color: rgba(96, 165, 250, 0.15) !important;
        }
        /* Sub-items (methods/functions) indented */
        nav ul.methods {
            padding-left: 15px !important;
        }
        nav ul.methods li a {
            color: #9ca3af !important;
            font-size: 13px !important;
            padding: 6px 15px !important;
            font-weight: 400 !important;
        }
        nav ul.methods li a:hover {
            color: #c9d1d9 !important;
        }
        nav > h2:first-child {
            font-size: 16px !important;
            font-weight: 700 !important;
            padding: 12px 15px !important;
        }

        /* Main content area - dark background */
        #main {
            background-color: #1a1a1a !important;
            padding: 20px !important;
        }

        /* Article and sections - ensure dark background */
        article, section, .container-overview, .description {
            background-color: #1a1a1a !important;
        }

        /* Images - style demo images */
        img {
            max-width: 100% !important;
            height: auto !important;
            border: 1px solid #404040 !important;
            border-radius: 8px !important;
            margin: 20px 0 !important;
        }

        /* Links */
        a {
            color: #60a5fa !important;
            text-decoration: none !important;
        }
        a:hover {
            color: #93c5fd !important;
            text-decoration: underline !important;
        }

        /* Headings */
        h1, h2, h3, h4, h5, h6 {
            color: #e0e0e0 !important;
            border-bottom-color: #404040 !important;
            background-color: transparent !important;
        }
        h4.name {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
        }

        /* Code blocks */
        pre {
            background-color: #0d1117 !important;
            border: 1px solid #404040 !important;
        }
        pre code {
            background-color: transparent !important;
        }
        code {
            background-color: #2a2a2a !important;
            color: #e0e0e0 !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
        }

        /* Tables */
        table {
            border-color: #404040 !important;
            background-color: #1a1a1a !important;
        }
        table thead tr {
            background-color: #242424 !important;
        }
        table tbody tr {
            background-color: #1a1a1a !important;
        }
        table tbody tr:nth-child(even) {
            background-color: #1f1f1f !important;
        }
        table td, table th {
            border-color: #404040 !important;
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }
        .params .name, .props .name {
            color: #10b981 !important;
            font-family: 'Courier New', monospace !important;
        }

        /* Descriptions and details */
        .description, .details, dt, dd, p, ul, ol, dl {
            color: #e0e0e0 !important;
            background-color: transparent !important;
        }

        /* Types */
        .type-signature {
            color: #a78bfa !important;
        }

        /* Source links */
        .details .details-item-container {
            border-left-color: #404040 !important;
        }

        /* Breadcrumbs */
        .page-title {
            color: #e0e0e0 !important;
        }

        /* Search */
        #nav-search {
            background-color: #2a2a2a !important;
            border: 1px solid #404040 !important;
            color: #e0e0e0 !important;
        }

        /* Mobile nav trigger */
        .navicon-button {
            background-color: #2a2a2a !important;
        }

        /* Footer */
        footer {
            background-color: #1a1a1a !important;
            color: #9ca3af !important;
            border-top: 1px solid #404040 !important;
            text-align: center !important;
            padding: 20px !important;
        }

        /* Remove horizontal scrollbar and white borders */
        * {
            box-sizing: border-box !important;
        }
    </style>
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api.html">api</a><ul class='methods'><li data-type='method'><a href="module-api.html#.activateCampaign">activateCampaign</a></li><li data-type='method'><a href="module-api.html#.deleteChat">deleteChat</a></li><li data-type='method'><a href="module-api.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-api.html#.departVessel">departVessel</a></li><li data-type='method'><a href="module-api.html#.doWearMaintenanceBulk">doWearMaintenanceBulk</a></li><li data-type='method'><a href="module-api.html#.fetchAcquirableVessels">fetchAcquirableVessels</a></li><li data-type='method'><a href="module-api.html#.fetchAllianceMembers">fetchAllianceMembers</a></li><li data-type='method'><a href="module-api.html#.fetchAssignedPorts">fetchAssignedPorts</a></li><li data-type='method'><a href="module-api.html#.fetchBunkerPrices">fetchBunkerPrices</a></li><li data-type='method'><a href="module-api.html#.fetchCampaigns">fetchCampaigns</a></li><li data-type='method'><a href="module-api.html#.fetchChat">fetchChat</a></li><li data-type='method'><a href="module-api.html#.fetchContacts">fetchContacts</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerChats">fetchMessengerChats</a></li><li data-type='method'><a href="module-api.html#.fetchMessengerMessages">fetchMessengerMessages</a></li><li data-type='method'><a href="module-api.html#.fetchUserSettings">fetchUserSettings</a></li><li data-type='method'><a href="module-api.html#.fetchVessels">fetchVessels</a></li><li data-type='method'><a href="module-api.html#.getCompanyNameCached">getCompanyNameCached</a></li><li data-type='method'><a href="module-api.html#.getMaintenanceCost">getMaintenanceCost</a></li><li data-type='method'><a href="module-api.html#.purchaseCO2">purchaseCO2</a></li><li data-type='method'><a href="module-api.html#.purchaseFuel">purchaseFuel</a></li><li data-type='method'><a href="module-api.html#.purchaseVessel">purchaseVessel</a></li><li data-type='method'><a href="module-api.html#.sendChatMessage">sendChatMessage</a></li><li data-type='method'><a href="module-api.html#.sendPrivateMessage">sendPrivateMessage</a></li></ul></li><li><a href="module-app.html">app</a></li><li><a href="module-automation.html">automation</a><ul class='methods'><li data-type='method'><a href="module-automation.html#.initAutomation">initAutomation</a></li><li data-type='method'><a href="module-automation.html#.runAutomationChecks">runAutomationChecks</a></li><li data-type='method'><a href="module-automation.html#.triggerAutoRebuyChecks">triggerAutoRebuyChecks</a></li><li data-type='method'><a href="module-automation.html#~calculateRemainingDemand">calculateRemainingDemand</a></li><li data-type='method'><a href="module-automation.html#~checkAutoCampaignRenewal">checkAutoCampaignRenewal</a></li><li data-type='method'><a href="module-automation.html#~checkAutoDepartAll">checkAutoDepartAll</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyCO2">checkAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~checkAutoRebuyFuel">checkAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~getTotalCapacity">getTotalCapacity</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyCO2">performAutoRebuyCO2</a></li><li data-type='method'><a href="module-automation.html#~performAutoRebuyFuel">performAutoRebuyFuel</a></li><li data-type='method'><a href="module-automation.html#~sendAutoPilotFeedback">sendAutoPilotFeedback</a></li><li data-type='method'><a href="module-automation.html#~showCenterAlert">showCenterAlert</a></li><li data-type='method'><a href="module-automation.html#~updateAutoDepartLabel">updateAutoDepartLabel</a></li></ul></li><li><a href="module-bunker-management.html">bunker-management</a><ul class='methods'><li data-type='method'><a href="module-bunker-management.html#.buyMaxCO2">buyMaxCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.buyMaxFuel">buyMaxFuel</a></li><li data-type='method'><a href="module-bunker-management.html#.getCurrentBunkerState">getCurrentBunkerState</a></li><li data-type='method'><a href="module-bunker-management.html#.updateBunkerStatus">updateBunkerStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCampaignsStatus">updateCampaignsStatus</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCO2">updateCurrentCO2</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentCash">updateCurrentCash</a></li><li data-type='method'><a href="module-bunker-management.html#.updateCurrentFuel">updateCurrentFuel</a></li></ul></li><li><a href="module-chat.html">chat</a><ul class='methods'><li data-type='method'><a href="module-chat.html#.displayMessages">displayMessages</a></li><li data-type='method'><a href="module-chat.html#.handleMessageInput">handleMessageInput</a></li><li data-type='method'><a href="module-chat.html#.initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-chat.html#.loadAllianceMembers">loadAllianceMembers</a></li><li data-type='method'><a href="module-chat.html#.loadMessages">loadMessages</a></li><li data-type='method'><a href="module-chat.html#.parseMessageWithMentions">parseMessageWithMentions</a></li><li data-type='method'><a href="module-chat.html#.sendMessage">sendMessage</a></li><li data-type='method'><a href="module-chat.html#.setChatScrollListener">setChatScrollListener</a></li><li data-type='method'><a href="module-chat.html#~handleBackendAutoRepairComplete">handleBackendAutoRepairComplete</a></li></ul></li><li><a href="module-coop.html">coop</a><ul class='methods'><li data-type='method'><a href="module-coop.html#.closeCoopOverlay">closeCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.fetchCoopData">fetchCoopData</a></li><li data-type='method'><a href="module-coop.html#.sendCoopMax">sendCoopMax</a></li><li data-type='method'><a href="module-coop.html#.showCoopOverlay">showCoopOverlay</a></li><li data-type='method'><a href="module-coop.html#.updateCoopBadge">updateCoopBadge</a></li></ul></li><li><a href="module-messenger.html">messenger</a><ul class='methods'><li data-type='method'><a href="module-messenger.html#.closeAllChats">closeAllChats</a></li><li data-type='method'><a href="module-messenger.html#.closeChatSelection">closeChatSelection</a></li><li data-type='method'><a href="module-messenger.html#.openMessenger">openMessenger</a></li><li data-type='method'><a href="module-messenger.html#.openNewChat">openNewChat</a></li><li data-type='method'><a href="module-messenger.html#.showAllChats">showAllChats</a></li><li data-type='method'><a href="module-messenger.html#.updateUnreadBadge">updateUnreadBadge</a></li><li data-type='method'><a href="module-messenger.html#~loadPrivateMessages">loadPrivateMessages</a></li></ul></li><li><a href="module-server_automation.html">server/automation</a><ul class='methods'><li data-type='method'><a href="module-server_automation.html#~getRandomInterval">getRandomInterval</a></li><li data-type='method'><a href="module-server_automation.html#~initialize">initialize</a></li><li data-type='method'><a href="module-server_automation.html#~loadSettings">loadSettings</a></li><li data-type='method'><a href="module-server_automation.html#~parseInterval">parseInterval</a></li><li data-type='method'><a href="module-server_automation.html#~restartAutoRepair">restartAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~runAutoRepair">runAutoRepair</a></li><li data-type='method'><a href="module-server_automation.html#~scheduleAutoRepair">scheduleAutoRepair</a></li></ul></li><li><a href="module-server_certificate.html">server/certificate</a><ul class='methods'><li data-type='method'><a href="module-server_certificate.html#~createHttpsServer">createHttpsServer</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCA">generateCA</a></li><li data-type='method'><a href="module-server_certificate.html#~generateCertificate">generateCertificate</a></li><li data-type='method'><a href="module-server_certificate.html#~getNetworkIPs">getNetworkIPs</a></li><li data-type='method'><a href="module-server_certificate.html#~loadCertificate">loadCertificate</a></li></ul></li><li><a href="module-server_config.html">server/config</a></li><li><a href="module-server_middleware_index.html">server/middleware/index</a><ul class='methods'><li data-type='method'><a href="module-server_middleware_index.html#~setupMiddleware">setupMiddleware</a></li></ul></li><li><a href="module-server_routes_alliance.html">server/routes/alliance</a><ul class='methods'><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/alliance-members">GET /api/alliance-members</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.GET/api/chat">GET /api/chat</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/company-name">POST /api/company-name</a></li><li data-type='method'><a href="module-server_routes_alliance.html#.POST/api/send-message">POST /api/send-message</a></li></ul></li><li><a href="module-server_routes_coop.html">server/routes/coop</a><ul class='methods'><li data-type='method'><a href="module-server_routes_coop.html#.GET/api/coop/data">GET /api/coop/data</a></li></ul></li><li><a href="module-server_routes_game.html">server/routes/game</a></li><li><a href="module-server_routes_messenger.html">server/routes/messenger</a><ul class='methods'><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/contact/get-contacts">GET /api/contact/get-contacts</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.GET/api/messenger/get-chats">GET /api/messenger/get-chats</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/delete-chat">POST /api/messenger/delete-chat</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/get-messages">POST /api/messenger/get-messages</a></li><li data-type='method'><a href="module-server_routes_messenger.html#.POST/api/messenger/send-private">POST /api/messenger/send-private</a></li></ul></li><li><a href="module-server_routes_settings.html">server/routes/settings</a><ul class='methods'><li data-type='method'><a href="module-server_routes_settings.html#.GET/api/settings">GET /api/settings</a></li><li data-type='method'><a href="module-server_routes_settings.html#.POST/api/settings">POST /api/settings</a></li></ul></li><li><a href="module-server_utils_api.html">server/utils/api</a><ul class='methods'><li data-type='method'><a href="module-server_utils_api.html#~apiCall">apiCall</a></li><li data-type='method'><a href="module-server_utils_api.html#~getAllianceId">getAllianceId</a></li><li data-type='method'><a href="module-server_utils_api.html#~getChatFeed">getChatFeed</a></li><li data-type='method'><a href="module-server_utils_api.html#~getCompanyName">getCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserCompanyName">getUserCompanyName</a></li><li data-type='method'><a href="module-server_utils_api.html#~getUserId">getUserId</a></li><li data-type='method'><a href="module-server_utils_api.html#~initializeAlliance">initializeAlliance</a></li></ul></li><li><a href="module-server_websocket.html">server/websocket</a><ul class='methods'><li data-type='method'><a href="module-server_websocket.html#~broadcast">broadcast</a></li><li data-type='method'><a href="module-server_websocket.html#~initWebSocket">initWebSocket</a></li><li data-type='method'><a href="module-server_websocket.html#~startChatAutoRefresh">startChatAutoRefresh</a></li><li data-type='method'><a href="module-server_websocket.html#~stopChatAutoRefresh">stopChatAutoRefresh</a></li></ul></li><li><a href="module-ui-dialogs.html">ui-dialogs</a><ul class='methods'><li data-type='method'><a href="module-ui-dialogs.html#.buyCampaign">buyCampaign</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeCampaignsOverlay">closeCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.closeSettings">closeSettings</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showCampaignsOverlay">showCampaignsOverlay</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showConfirmDialog">showConfirmDialog</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showContactList">showContactList</a></li><li data-type='method'><a href="module-ui-dialogs.html#.showSettings">showSettings</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#.escapeHtml">escapeHtml</a></li><li data-type='method'><a href="module-utils.html#.formatNumber">formatNumber</a></li><li data-type='method'><a href="module-utils.html#.registerServiceWorker">registerServiceWorker</a></li><li data-type='method'><a href="module-utils.html#.renderStars">renderStars</a></li><li data-type='method'><a href="module-utils.html#.requestNotificationPermission">requestNotificationPermission</a></li><li data-type='method'><a href="module-utils.html#.showNotification">showNotification</a></li><li data-type='method'><a href="module-utils.html#.showSideNotification">showSideNotification</a></li></ul></li><li><a href="module-vessel-management.html">vessel-management</a><ul class='methods'><li data-type='method'><a href="module-vessel-management.html#.departAllVessels">departAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.purchaseSingleVessel">purchaseSingleVessel</a></li><li data-type='method'><a href="module-vessel-management.html#.repairAllVessels">repairAllVessels</a></li><li data-type='method'><a href="module-vessel-management.html#.updateVesselCount">updateVesselCount</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#express">express</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">server/certificate.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview HTTPS Certificate Generation and Management Module
 *
 * This module handles automatic generation and management of self-signed SSL/TLS certificates
 * for the Shipping Manager CoPilot application. It creates a Certificate Authority (CA) that can
 * be trusted by browsers, then generates server certificates signed by that CA.
 *
 * Key Features:
 * - Generates a long-lived (10 year) Certificate Authority that can be installed in system trust store
 * - Creates server certificates with Subject Alternative Names (SANs) for all network interfaces
 * - Supports localhost, 127.0.0.1, ::1, and all LAN IP addresses (e.g., 192.168.x.x)
 * - Provides automatic CA installation on Windows via certutil (requires admin rights)
 * - Certificates valid for 1 year and automatically regenerated when missing
 *
 * Why This Exists:
 * - WebSocket connections (wss://) require HTTPS, not just HTTP
 * - Browser security policies require trusted certificates for WebSocket communication
 * - Supporting multiple network interfaces allows access from other devices on LAN
 * - CA-based approach allows one-time browser trust instead of per-certificate warnings
 *
 * Certificate Chain:
 *   CA Certificate (10yr) → Server Certificate (1yr)
 *   ca-cert.pem, ca-key.pem → cert.pem, key.pem
 *
 * Installation Workflow:
 * 1. First run: Generate CA + server cert, prompt for CA installation
 * 2. User installs CA in system trust store (manual or automatic)
 * 3. All future server certificates signed by this CA are automatically trusted
 * 4. Server cert regenerated when missing (uses existing CA if available)
 *
 * @requires fs - File system operations for certificate storage
 * @requires path - Path resolution for certificate files
 * @requires https - HTTPS server creation
 * @requires os - Network interface detection and platform detection
 * @requires child_process - Certificate installation via certutil
 * @requires node-forge - RSA key generation and X.509 certificate creation
 * @module server/certificate
 */

const fs = require('fs');
const path = require('path');
const https = require('https');
const os = require('os');
const { execSync } = require('child_process');
const forge = require('node-forge');

/**
 * File path for the Certificate Authority certificate (10-year validity)
 * @constant {string}
 */
const CA_CERT_PATH = path.join(__dirname, '..', 'ca-cert.pem');

/**
 * File path for the Certificate Authority private key
 * @constant {string}
 */
const CA_KEY_PATH = path.join(__dirname, '..', 'ca-key.pem');

/**
 * File path for the server certificate (1-year validity)
 * @constant {string}
 */
const CERT_PATH = path.join(__dirname, '..', 'cert.pem');

/**
 * File path for the server private key
 * @constant {string}
 */
const KEY_PATH = path.join(__dirname, '..', 'key.pem');

/**
 * Detects all non-internal IPv4 addresses from network interfaces.
 *
 * This function scans all network interfaces on the system and collects their IPv4 addresses,
 * excluding loopback/internal interfaces. These IPs are used as Subject Alternative Names (SANs)
 * in the server certificate, allowing the application to be accessed from other devices on the LAN.
 *
 * Why This Matters:
 * - Browsers require certificates to explicitly list all hostnames/IPs they'll be accessed via
 * - Without SANs for network IPs, accessing via 192.168.x.x would show certificate warnings
 * - Dynamically detecting IPs ensures certificates work across different network configurations
 *
 * @function getNetworkIPs
 * @returns {string[]} Array of IPv4 addresses (e.g., ['192.168.1.100', '10.0.0.5'])
 *
 * @example
 * const ips = getNetworkIPs();
 * console.log(ips); // ['192.168.1.100', '192.168.56.1']
 */
function getNetworkIPs() {
  const networkInterfaces = os.networkInterfaces();
  const ips = [];

  for (const name of Object.keys(networkInterfaces)) {
    for (const net of networkInterfaces[name]) {
      if (net.family === 'IPv4' &amp;&amp; !net.internal) {
        ips.push(net.address);
      }
    }
  }

  return ips;
}

/**
 * Generates a self-signed Certificate Authority (CA) for signing server certificates.
 *
 * This function creates a long-lived (10 year) CA certificate and private key that can be
 * installed in the system's trust store. Once installed, all server certificates signed by
 * this CA will be automatically trusted by browsers without security warnings.
 *
 * Why This Approach:
 * - Self-signed server certificates trigger warnings on every access
 * - CA-based approach requires one-time installation, then all future certs are trusted
 * - 10-year validity means CA doesn't need frequent regeneration
 * - Automatic installation on Windows (via certutil) streamlines setup
 *
 * Certificate Properties:
 * - 2048-bit RSA key pair
 * - SHA-256 signature algorithm
 * - Basic Constraints: CA=true (can sign other certificates)
 * - Key Usage: Certificate Signing, CRL Signing
 * - Common Name: "Shipping Manager CoPilot CA"
 *
 * Platform-Specific Installation:
 * - Windows: Prompts UAC dialog for automatic installation via certutil
 * - macOS: Provides manual command for adding to System keychain
 * - Linux: Provides manual command for adding to ca-certificates
 *
 * Side Effects:
 * - Writes ca-cert.pem and ca-key.pem to project root
 * - Attempts automatic installation on Windows (requires user approval)
 * - Logs installation instructions to console
 *
 * @function generateCA
 * @returns {{cert: string, key: string}} Object with PEM-encoded CA certificate and private key
 *
 * @example
 * const ca = generateCA();
 * // Creates ca-cert.pem and ca-key.pem in project root
 * // On Windows, shows UAC prompt for installation
 * console.log(ca.cert); // PEM-encoded certificate
 */
function generateCA() {
  console.log('Generating Certificate Authority (CA)...');

  const keys = forge.pki.rsa.generateKeyPair(2048);
  const cert = forge.pki.createCertificate();

  cert.publicKey = keys.publicKey;
  cert.serialNumber = '01';
  cert.validity.notBefore = new Date();
  cert.validity.notAfter = new Date();
  cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 10);

  const attrs = [
    { name: 'commonName', value: 'Shipping Manager CoPilot CA' },
    { name: 'organizationName', value: 'Shipping Manager CoPilot' },
    { name: 'countryName', value: 'US' }
  ];

  cert.setSubject(attrs);
  cert.setIssuer(attrs);
  cert.setExtensions([
    {
      name: 'basicConstraints',
      cA: true
    },
    {
      name: 'keyUsage',
      keyCertSign: true,
      cRLSign: true
    }
  ]);

  cert.sign(keys.privateKey, forge.md.sha256.create());

  const caPem = forge.pki.certificateToPem(cert);
  const caKeyPem = forge.pki.privateKeyToPem(keys.privateKey);

  fs.writeFileSync(CA_CERT_PATH, caPem);
  fs.writeFileSync(CA_KEY_PATH, caKeyPem);

  console.log('✓ CA generated successfully');

  // Try to install CA certificate automatically on Windows
  if (os.platform() === 'win32') {
    try {
      console.log('\n🔒 Installing CA certificate to Windows Trust Store...');
      console.log('   (Admin rights required - UAC dialog will appear)\n');

      execSync(`powershell -Command "Start-Process certutil -ArgumentList '-addstore','-f','Root','${CA_CERT_PATH}' -Verb RunAs -Wait"`, {
        stdio: 'inherit'
      });

      console.log('\n✓ CA certificate installed successfully!');
      console.log('✓ Browser will now trust all certificates from this CA\n');
    } catch (error) {
      console.log('\n⚠ Installation cancelled or failed');
      console.log('📋 Manual installation:');
      console.log(`   1. Right-click Command Prompt → "Run as Administrator"`);
      console.log(`   2. Run: certutil -addstore -f "Root" "${CA_CERT_PATH}"\n`);
    }
  } else if (os.platform() === 'darwin') {
    console.log(`\n📋 macOS: sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain "${CA_CERT_PATH}"\n`);
  } else {
    console.log(`\n📋 Linux: sudo cp "${CA_CERT_PATH}" /usr/local/share/ca-certificates/ &amp;&amp; sudo update-ca-certificates\n`);
  }

  return { cert: caPem, key: caKeyPem };
}

/**
 * Generates a server certificate signed by the Certificate Authority.
 *
 * This function creates a 1-year server certificate with Subject Alternative Names (SANs)
 * covering all network interfaces. The certificate is signed by the CA (loaded or generated),
 * allowing browsers to trust it without warnings if the CA is installed in the system trust store.
 *
 * Why This Design:
 * - 1-year validity balances security (shorter lifespan) with convenience (not too frequent renewal)
 * - SANs for all network IPs enable access from other devices on LAN
 * - localhost + 127.0.0.1 + ::1 ensure local development works
 * - CA-signed approach means regenerating server cert doesn't require browser reconfiguration
 *
 * Certificate Properties:
 * - 2048-bit RSA key pair
 * - SHA-256 signature algorithm
 * - Common Name: "localhost"
 * - Subject Alternative Names:
 *   - DNS: localhost
 *   - IP: 127.0.0.1, ::1
 *   - IP: All detected network IPs (e.g., 192.168.1.100)
 * - Extended Key Usage: Server Authentication, Client Authentication
 *
 * Certificate Workflow:
 * 1. Check if CA exists, generate if missing
 * 2. Load CA certificate and private key
 * 3. Generate new server key pair
 * 4. Detect all network IPs via getNetworkIPs()
 * 5. Create certificate with SANs for localhost + all IPs
 * 6. Sign certificate with CA private key
 * 7. Write cert.pem and key.pem to disk
 *
 * Side Effects:
 * - May trigger CA generation if CA files don't exist
 * - Writes cert.pem and key.pem to project root
 * - Logs detected network IPs to console
 *
 * @function generateCertificate
 * @returns {void}
 *
 * @example
 * generateCertificate();
 * // Generates cert.pem and key.pem
 * // Console output:
 * //   "Adding network IP to certificate: 192.168.1.100"
 * //   "✓ Server certificate generated successfully"
 */
function generateCertificate() {
  console.log('Generating server certificate...');

  // Load or generate CA
  let caCert, caKey;
  if (!fs.existsSync(CA_CERT_PATH) || !fs.existsSync(CA_KEY_PATH)) {
    const ca = generateCA();
    caCert = forge.pki.certificateFromPem(ca.cert);
    caKey = forge.pki.privateKeyFromPem(ca.key);
  } else {
    caCert = forge.pki.certificateFromPem(fs.readFileSync(CA_CERT_PATH, 'utf8'));
    caKey = forge.pki.privateKeyFromPem(fs.readFileSync(CA_KEY_PATH, 'utf8'));
  }

  // Generate server key pair
  const keys = forge.pki.rsa.generateKeyPair(2048);
  const cert = forge.pki.createCertificate();

  cert.publicKey = keys.publicKey;
  cert.serialNumber = '02';
  cert.validity.notBefore = new Date();
  cert.validity.notAfter = new Date();
  cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 1);

  const attrs = [
    { name: 'commonName', value: 'localhost' },
    { name: 'organizationName', value: 'Shipping Manager Chat' },
    { name: 'countryName', value: 'US' }
  ];

  cert.setSubject(attrs);
  cert.setIssuer(caCert.subject.attributes);

  // Get all network IPs
  const networkIPs = getNetworkIPs();

  // Build altNames array
  const altNames = [
    { type: 2, value: 'localhost' },
    { type: 7, ip: '127.0.0.1' },
    { type: 7, ip: '::1' }
  ];

  networkIPs.forEach(ip => {
    altNames.push({ type: 7, ip });
    console.log(`  Adding network IP to certificate: ${ip}`);
  });

  cert.setExtensions([
    {
      name: 'basicConstraints',
      cA: false
    },
    {
      name: 'keyUsage',
      digitalSignature: true,
      keyEncipherment: true
    },
    {
      name: 'extKeyUsage',
      serverAuth: true,
      clientAuth: true
    },
    {
      name: 'subjectAltName',
      altNames: altNames
    }
  ]);

  cert.sign(caKey, forge.md.sha256.create());

  const certPem = forge.pki.certificateToPem(cert);
  const keyPem = forge.pki.privateKeyToPem(keys.privateKey);

  fs.writeFileSync(CERT_PATH, certPem);
  fs.writeFileSync(KEY_PATH, keyPem);

  console.log('✓ Server certificate generated successfully');
}

/**
 * Loads existing server certificate or generates a new one if missing.
 *
 * This function implements lazy certificate generation - it only creates certificates
 * when they don't exist. This ensures the server can start quickly on subsequent runs
 * without regenerating certificates unnecessarily.
 *
 * Why This Pattern:
 * - Certificates are only generated when needed (first run or after deletion)
 * - Automatic regeneration ensures server always has valid certificates
 * - Existing certificates are reused to maintain consistent SSL fingerprints
 * - No manual intervention required for certificate management
 *
 * Certificate Lifecycle:
 * 1. Check if cert.pem and key.pem exist
 * 2. If missing, generate new server certificate (which may also generate CA)
 * 3. Read certificate and key files into memory
 * 4. Return as Buffer objects for HTTPS server
 *
 * @function loadCertificate
 * @returns {{cert: Buffer, key: Buffer}} Object with certificate and private key as Buffers
 *
 * @example
 * const credentials = loadCertificate();
 * const server = https.createServer(credentials, app);
 * // If certificates missing, generates them first
 * // Otherwise, loads existing cert.pem and key.pem
 */
function loadCertificate() {
  if (!fs.existsSync(CERT_PATH) || !fs.existsSync(KEY_PATH)) {
    generateCertificate();
  }

  return {
    cert: fs.readFileSync(CERT_PATH),
    key: fs.readFileSync(KEY_PATH)
  };
}

/**
 * Creates an HTTPS server with automatically managed SSL certificates.
 *
 * This is the primary export function used by app.js to create the HTTPS server.
 * It handles certificate loading/generation transparently, providing a simple
 * interface for creating a secure server.
 *
 * Why HTTPS Required:
 * - WebSocket Secure (wss://) connections require HTTPS, not HTTP
 * - Modern browsers block insecure WebSocket connections from secure contexts
 * - Session cookies from shippingmanager.cc may have Secure flag, requiring HTTPS
 * - Accessing from other devices on LAN requires trusted certificates
 *
 * Certificate Management:
 * - Automatically loads or generates certificates via loadCertificate()
 * - No manual intervention required
 * - Server starts with valid HTTPS configuration on first run
 *
 * @function createHttpsServer
 * @param {Express} app - Express application instance
 * @returns {https.Server} HTTPS server instance configured with SSL certificates
 *
 * @example
 * const express = require('express');
 * const { createHttpsServer } = require('./server/certificate');
 *
 * const app = express();
 * const server = createHttpsServer(app);
 * server.listen(12345, () => {
 *   console.log('HTTPS server running on port 12345');
 * });
 */
function createHttpsServer(app) {
  const credentials = loadCertificate();
  return https.createServer(credentials, app);
}

module.exports = {
  createHttpsServer,
  loadCertificate
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation Version: 0.0.7 - ShippingManager CoPilot
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
